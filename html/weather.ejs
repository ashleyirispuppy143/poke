	<!--
	    This Source Code Form is subject to the terms of the GNU General Public License:
	   
	    Copyright (C) 2021-2026 PokeWeather Of Poke Project, a part of The Poke Project Initiative (initiative.poketube.fun) 
	    source code :https://codeberg.org/ashley/poke
	
	    This program is free software: you can redistribute it and/or modify
	    it under the terms of the GNU General Public License as published by
	    the Free Software Foundation, either version 3 of the License, or
	    (at your option) any later version.
	
	    This program is distributed in the hope that it will be useful,
	    but WITHOUT ANY WARRANTY; without even the implied warranty of
	    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	    GNU General Public License for more details.
	
	    You should have received a copy of the GNU General Public License
	    along with this program. If not, see https://www.gnu.org/licenses/.
	--><!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>PokeWeather</title>
<meta name="theme-color" content="#0ea5e9" id="meta-theme-color" />
<meta name="color-scheme" content="dark light" />
<meta content="PokeWeather" property="og:title">
<meta content="View Weather info :3c" property="twitter:description">
<meta content="/static/poke-weather.png" property="og:image" />
<meta content="summary_large_image" name="twitter:card">

<style>
 :root {
  --text-main: #ffffff;
  --text-muted: rgba(255, 255, 255, 0.7);
  --text-dim: rgba(255, 255, 255, 0.5);
  
  --glass-bg: rgba(0, 0, 0, 0.2);
  --glass-border: rgba(255, 255, 255, 0.15);
  --glass-highlight: rgba(255, 255, 255, 0.25);
  --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
  
  --radius-lg: 28px;
  --radius-md: 16px;
  --radius-sm: 10px;
  
  --app-max-width: 700px;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

html, body {
  min-height: 100%;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Inter', system-ui, -apple-system, sans-serif;
  color: var(--text-main);
  -webkit-font-smoothing: antialiased;
  line-height: 1.5;
  background-color: #020617; /* Fallback */
  background-size: cover;
  background-attachment: fixed;
  transition: background 1.5s ease;
  overflow-x: hidden;
}

@font-face {
  src: url("https://p.poketube.fun/https://cdn.glitch.global/43b6691a-c8db-41d4-921c-8cf6aa0d9108/robotoflex.ttf?v=16683434286881");
  font-family: "PokeTube Flex";
  font-style: normal;
  font-display: swap;
}

/* Background Canvas */
#bg-canvas {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: -1;
  pointer-events: none;
}

/* App Container (Mobile Feel) */
.app-container {
  max-width: var(--app-max-width);
  margin: 0 auto;
  padding: 20px 16px 40px 16px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

a { color: inherit; text-decoration: none; transition: 0.2s; }
h1, h2, h3, h4 { margin: 0; font-weight: 600; }

/* Default state hiding */
.ssr { display: none; }
.hidden { display: none !important; }
main { display: flex; flex-direction: column; gap: 16px; }

 header {
  position: relative;
  z-index: 10;
  margin-bottom: 10px;
}

.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.loc-chip {
  font-size: 24px;
  font-weight: 700;
  text-shadow: 0 2px 10px rgba(0,0,0,0.3);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  display: flex;
  align-items: center;
  gap: 8px;
}

.controls { display: flex; gap: 8px; }

button, .btn {
  height: 38px;
  padding: 0 16px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  font-size: 14px;
  font-weight: 600;
  border-radius: 20px;
  border: 1px solid var(--glass-border);
  background: var(--glass-bg);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  color: var(--text-main);
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

button:hover, .btn:hover { background: rgba(255, 255, 255, 0.1); transform: translateY(-1px); }
button:active { transform: translateY(1px); }

 .search {
  position: relative;
  display: flex;
  width: 100%;
}

.search input[type="search"] {
  width: 100%;
  height: 48px;
  background: rgba(0, 0, 0, 0.25);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid var(--glass-border);
  border-radius: 24px;
  padding: 0 100px 0 20px;
  color: white;
  font-size: 16px;
  outline: none;
  transition: all 0.2s;
  box-shadow: var(--glass-shadow);
}

.search input[type="search"]::placeholder { color: rgba(255,255,255,0.6); }
.search input[type="search"]:focus {
  background: rgba(0, 0, 0, 0.4);
  border-color: var(--glass-highlight);
}

.search .search-actions {
  position: absolute;
  right: 6px;
  top: 6px;
  display: flex;
  gap: 4px;
}

.search button.icon-btn {
  height: 36px;
  width: 36px;
  padding: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.1);
  border: none;
}

.search button.icon-btn:hover { background: rgba(255, 255, 255, 0.2); }

 .search .suggest {
  position: absolute;
  top: calc(100% + 8px);
  left: 0;
  right: 0;
  background: rgba(20, 20, 20, 0.85);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
  z-index: 2000;
  display: none;
}

.search .suggest button {
  width: 100%;
  text-align: left;
  background: transparent;
  border: none;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  border-radius: 0;
  padding: 14px 20px;
  font-weight: 500;
  color: var(--text-main);
  box-shadow: none;
}
.search .suggest button:last-child { border-bottom: none; }
.search .suggest button:hover { background: rgba(255, 255, 255, 0.1); }

 .glass-panel {
  background: var(--glass-bg);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-lg);
  padding: 24px;
  box-shadow: var(--glass-shadow);
  position: relative;
  overflow: hidden;
}

.section-title {
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-muted);
  margin-bottom: 16px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 6px;
}

 .hero-weather {
  text-align: center;
  padding: 40px 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.hero-weather .temp {
  font-family: "PokeTube Flex", sans-serif;
  font-size: 110px;
  font-weight: 800;
  line-height: 1;
  letter-spacing: -4px;
  margin: 10px 0 5px 0;
}

.hero-weather .desc {
  font-size: 22px;
  font-weight: 500;
  color: var(--text-main);
}

.hero-weather .hl {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-muted);
  margin-top: 8px;
}

/* Mini Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}
@media (min-width: 500px) { .stats-grid { grid-template-columns: repeat(4, 1fr); } }

.stat-box {
  background: rgba(0, 0, 0, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.05);
  border-radius: var(--radius-md);
  padding: 16px;
}

.stat-box h4 {
  font-size: 12px;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 6px;
}
.stat-box .val { font-size: 18px; font-weight: 700; }

 .hourly-scroll {
  display: flex;
  gap: 12px;
  overflow-x: auto;
  padding-bottom: 8px;
  scroll-snap-type: x mandatory;
  scrollbar-width: none; /* Firefox */
}
.hourly-scroll::-webkit-scrollbar { display: none; } /* Chrome */

.hour-item {
  min-width: 65px;
  scroll-snap-align: start;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}

.hour-item .time { font-size: 14px; font-weight: 600; color: var(--text-main); }
.hour-item .icon { font-size: 24px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
.hour-item .temp { font-size: 16px; font-weight: 700; }
.hour-item .pop { font-size: 12px; color: #38bdf8; font-weight: 600; min-height: 18px;}

 .chart-container {
  margin-top: 20px;
  width: 100%;
  height: 80px;
  position: relative;
}
canvas#chart {
  width: 100%;
  height: 100%;
  filter: drop-shadow(0 2px 8px rgba(0,0,0,0.3));
}

 .daily-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.day-row {
  display: grid;
  grid-template-columns: 40px 50px 1fr auto auto;
  align-items: center;
  font-size: 16px;
  font-weight: 600;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  padding-bottom: 12px;
}
.day-row:last-child { border-bottom: none; padding-bottom: 0; }

.day-row .icon { font-size: 24px; text-align: center; }
.day-row .desc { color: var(--text-muted); font-size: 14px; font-weight: 500; text-align: right; padding-right: 16px;}
.day-row .hi { width: 35px; text-align: right; }
.day-row .lo { width: 35px; text-align: right; color: var(--text-dim); }

 footer {
  text-align: center;
  font-size: 13px;
  color: var(--text-dim);
  margin-top: 20px;
}
footer a { text-decoration: underline; text-decoration-color: rgba(255,255,255,0.2); }
footer a:hover { color: var(--text-main); }

.loading { opacity: 0.5; pointer-events: none; }

 <noscript>
  <style>
    .ssr { display: flex !important; flex-direction: column; gap: 16px; }
    main { display: none !important; }
  </style>
</noscript>

</style>
</head>

<body class="<%= ssr && ssr.forceNoJS ? 'no-js' : '' %>">
  
  <canvas id="bg-canvas"></canvas>

  <div class="app-container">
    <header>
      <div class="top-bar">
        <div class="loc-chip">
          <span>üìç</span>
          <span id="locChip"><%= (ssr && ssr.name) || 'Loading...' %></span>
        </div>
        <div class="controls">
          <button id="btnUnits" title="Toggle ¬∞C/¬∞F">¬∞C</button>
          <a class="btn" href="#" id="btnShare" title="Share">üîó</a>
        </div>
      </div>

      <form class="search" role="search" action="/weather" method="GET" id="searchForm">
        <input id="q" name="q" type="search" placeholder="Search city or zip..." autocomplete="off" />
        <input type="hidden" name="units" id="unitsHidden" value="<%= (ssr && ssr.units) || 'metric' %>"/>
        <div class="search-actions">
          <button id="btnGeo" class="icon-btn" type="button" title="My Location">üß≠</button>
          <button id="btnSearch" class="icon-btn" type="submit" title="Search">üîç</button>
        </div>
        <div id="suggest" class="suggest" role="listbox"></div>
      </form>
    </header>

    <section class="ssr">
      <% if (ssr && ssr.current) { %>
      <div class="hero-weather">
        <div style="font-size: 60px; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.3));"><%= ssr.icon %></div>
        <div class="temp"><%= Math.round(ssr.current.temperature_2m) %>¬∞</div>
        <div class="desc"><%= ssr.desc %></div>
        <div class="hl">Feels like <%= Math.round(ssr.current.apparent_temperature) %>¬∞</div>
      </div>

      <div class="stats-grid">
        <div class="glass-panel stat-box"><h4>Wind</h4><div class="val"><%= Math.round(ssr.current.wind_speed_10m) %> <%= ssr.windUnit %></div></div>
        <div class="glass-panel stat-box"><h4>Humidity</h4><div class="val"><%= Math.round(ssr.current.relative_humidity_2m) %>%</div></div>
        <div class="glass-panel stat-box"><h4>UV Index</h4><div class="val"><%= ssr.daily.uv_index_max?.[0] ?? '‚Äî' %></div></div>
        <div class="glass-panel stat-box"><h4>Rain Prob</h4><div class="val"><%= ssr.popNext ?? '‚Äî' %>%</div></div>
      </div>

      <div class="glass-panel">
        <h3 class="section-title">üóì 7-Day Forecast</h3>
        <div class="daily-list">
          <% for (let i=0;i<ssr.daily.time.length;i++){ %>
            <div class="day-row">
              <div><%= ssr.dailyLabels[i].substring(0,3) %></div>
              <div class="icon"><%= ssr.dailyIcons[i] %></div>
              <div class="desc"><%= ssr.dailyTexts[i] %></div>
              <div class="hi"><%= Math.round(ssr.daily.temperature_2m_max[i]) %>¬∞</div>
              <div class="lo"><%= Math.round(ssr.daily.temperature_2m_min[i]) %>¬∞</div>
            </div>
          <% } %>
        </div>
      </div>
      <% } else { %>
        <div class="glass-panel" style="text-align: center; padding: 40px;"><p>No data to show.</p></div>
      <% } %>
    </section>

    <main>
      <div class="hero-weather current" aria-live="polite">
        <div id="currIcon" style="font-size: 60px; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.3)); animation: float 6s ease-in-out infinite;">‚Äî</div>
        <div class="temp" id="currTemp">‚Äî</div>
        <div class="desc" id="currDesc">‚Äî</div>
        <div class="hl">Feels like <span id="currFeels">‚Äî</span></div>
      </div>

      <div class="stats-grid current">
        <div class="glass-panel stat-box"><h4>üí® Wind</h4><div class="val" id="currWind">‚Äî</div></div>
        <div class="glass-panel stat-box"><h4>üíß Humidity</h4><div class="val" id="currHum">‚Äî</div></div>
        <div class="glass-panel stat-box"><h4>‚òÄÔ∏è UV Index</h4><div class="val" id="uv">‚Äî</div></div>
        <div class="glass-panel stat-box"><h4>üåß Rain Prob</h4><div class="val" id="pop">‚Äî</div></div>
      </div>

      <div class="glass-panel">
        <h3 class="section-title">‚è± Next 24 Hours</h3>
        <div id="hours" class="hourly-scroll"></div>
        <div class="chart-container">
          <canvas id="chart"></canvas>
        </div>
      </div>

      <div class="glass-panel">
        <h3 class="section-title">üóì 7-Day Forecast</h3>
        <div id="days" class="daily-list"></div>
      </div>
      
      <div class="glass-panel stats-grid">
         <div class="stat-box" style="background:transparent; border:none; padding:0;"><h4>Sunrise</h4><div class="val" id="sunrise">‚Äî</div></div>
         <div class="stat-box" style="background:transparent; border:none; padding:0;"><h4>Sunset</h4><div class="val" id="sunset">‚Äî</div></div>
         <div class="stat-box" style="background:transparent; border:none; padding:0;"><h4>Pressure</h4><div class="val" id="currPress">‚Äî</div></div>
      </div>
    </main>

    <footer>
      <div><a href="/privacy">Privacy Policy</a> ‚Ä¢ <a href="https://open-meteo.com/" target="_blank">Weather data by Open-Meteo</a></div>
    </footer>
  </div>
  
<style>
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
}
</style>

<script>
  window.__SSR__ = <%- JSON.stringify(ssr || {}) %>;
  window.__SSR_ROUTE__ = "/weather";
</script>

<script>
  const $ = s => document.querySelector(s);
  const units = JSON.parse(localStorage.getItem('pokeweather:units')||'{}');
  let state = {lat:null, lon:null, name:null, units:units.units||'<%= (ssr && ssr.units) || "metric" %>'};
  
  const btnUnits = $('#btnUnits'); 
  btnUnits.textContent = state.units==='metric' ? "¬∞C" : "¬∞F";

  const weatherText = (c) => {
    if([0].includes(c)) return "Clear sky";
    if([1].includes(c)) return "Mostly clear";
    if([2].includes(c)) return "Partly cloudy";
    if([3].includes(c)) return "Overcast";
    if([45,48].includes(c)) return "Fog";
    if([51,53,55].includes(c)) return "Drizzle";
    if([56,57].includes(c)) return "Freezing drizzle";
    if([61,63,65].includes(c)) return "Rain";
    if([66,67].includes(c)) return "Freezing rain";
    if([71,73,75].includes(c)) return "Snow";
    if([77].includes(c)) return "Snow grains";
    if([80,81,82].includes(c)) return "Showers";
    if([85,86].includes(c)) return "Snow showers";
    if([95].includes(c)) return "Thunderstorm";
    if([96,99].includes(c)) return "Storm & hail"; return "‚Äî"
  }
  
  const weatherIcon = (c, isDay) => {
    if(c===0) return isDay?"‚òÄÔ∏è":"‚ú®";
    if([1,2].includes(c)) return isDay?"üå§Ô∏è":"‚òÅÔ∏è";
    if([3].includes(c)) return "‚òÅÔ∏è";
    if([45,48].includes(c)) return "üå´Ô∏è";
    if([51,53,55,80,81,82].includes(c)) return "üå¶Ô∏è";
    if([61,63,65].includes(c)) return "üåßÔ∏è";
    if([66,67].includes(c)) return "üåßÔ∏è‚ùÑÔ∏è";
    if([71,73,75,77,85,86].includes(c)) return "‚ùÑÔ∏è";
    if([95,96,99].includes(c)) return "‚õàÔ∏è"; return "‚òÅÔ∏è";
  };

  const fmt = (n,u='') => n==null ? '‚Äî' : `${Math.round(n)}${u}`;
  const fmtTime = (s) => new Date(s).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  const fmtDay = (s) => new Date(s).toLocaleDateString([], {weekday:'short'});

  // --- CANVAS BACKGROUND ANIMATION SYSTEM ---
  const bgCanvas = document.getElementById('bg-canvas');
  const bgCtx = bgCanvas.getContext('2d');
  let particles = [];
  let animFrameId;
  let currentTheme = 'clear-day';

  function resizeCanvas() {
    bgCanvas.width = window.innerWidth;
    bgCanvas.height = window.innerHeight;
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  function updateBackground(weatherCode, isDay) {
    // 1. Determine aesthetic theme based on weather
    let theme = 'clear-day';
    let gradient = 'linear-gradient(to bottom, #3b82f6, #0ea5e9)'; // Default Day
    
    if (isDay === 0) gradient = 'linear-gradient(to bottom, #020617, #0f172a, #1e293b)'; // Night Base
    
    if ([0, 1].includes(weatherCode)) {
      theme = isDay ? 'clear-day' : 'clear-night';
      if(isDay) gradient = 'linear-gradient(to bottom, #38bdf8, #bae6fd)';
    } 
    else if ([2, 3, 45, 48].includes(weatherCode)) {
      theme = 'cloudy';
      gradient = isDay ? 'linear-gradient(to bottom, #64748b, #94a3b8)' : 'linear-gradient(to bottom, #1e293b, #334155)';
    }
    else if ([51,53,55,61,63,65,66,67,80,81,82].includes(weatherCode)) {
      theme = 'rain';
      gradient = isDay ? 'linear-gradient(to bottom, #475569, #64748b)' : 'linear-gradient(to bottom, #0f172a, #1e293b)';
    }
    else if ([71,73,75,77,85,86].includes(weatherCode)) {
      theme = 'snow';
      gradient = isDay ? 'linear-gradient(to bottom, #94a3b8, #cbd5e1)' : 'linear-gradient(to bottom, #1e293b, #475569)';
    }
    else if ([95,96,99].includes(weatherCode)) {
      theme = 'storm';
      gradient = 'linear-gradient(to bottom, #0f172a, #1e293b, #334155)';
    }

    document.body.style.backgroundImage = gradient;
    
    // Update theme meta color for mobile browsers
    const colorMatch = gradient.match(/#([0-9a-f]{6}|[0-9a-f]{3})/i);
    if(colorMatch) document.getElementById('meta-theme-color').content = colorMatch[0];

    // 2. Initialize particles
    cancelAnimationFrame(animFrameId);
    particles = [];
    currentTheme = theme;

    const w = bgCanvas.width;
    const h = bgCanvas.height;

    if (theme === 'clear-night') {
      // Stars
      for(let i=0; i<150; i++) particles.push({ x: Math.random()*w, y: Math.random()*h, r: Math.random()*1.5, a: Math.random(), s: 0.005 + Math.random()*0.02 });
    } else if (theme === 'rain' || theme === 'storm') {
      // Raindrops
      for(let i=0; i<120; i++) particles.push({ x: Math.random()*w, y: Math.random()*h, l: 15+Math.random()*20, sy: 15+Math.random()*10, sx: -1-Math.random()*2 });
    } else if (theme === 'snow') {
      // Snowflakes
      for(let i=0; i<150; i++) particles.push({ x: Math.random()*w, y: Math.random()*h, r: 1+Math.random()*3, sy: 1+Math.random()*2, a: Math.random()*Math.PI*2 });
    } else if (theme === 'cloudy') {
      // Abstract subtle moving clouds
      for(let i=0; i<15; i++) particles.push({ x: Math.random()*w, y: Math.random()*(h/2), r: 50+Math.random()*150, sx: 0.2+Math.random()*0.5, o: 0.05+Math.random()*0.1 });
    }

    drawParticles();
  }

  function drawParticles() {
    const w = bgCanvas.width;
    const h = bgCanvas.height;
    bgCtx.clearRect(0, 0, w, h);

    bgCtx.fillStyle = 'white';
    bgCtx.strokeStyle = 'rgba(255,255,255,0.4)';

    if (currentTheme === 'storm' && Math.random() < 0.01) {
       // Lightning flash
       bgCtx.fillStyle = 'rgba(255,255,255,0.3)';
       bgCtx.fillRect(0,0,w,h);
       bgCtx.fillStyle = 'white';
    }

    particles.forEach(p => {
      if (currentTheme === 'clear-night') {
        bgCtx.globalAlpha = Math.abs(Math.sin(p.a));
        bgCtx.beginPath(); bgCtx.arc(p.x, p.y, p.r, 0, Math.PI*2); bgCtx.fill();
        p.a += p.s;
      } 
      else if (currentTheme === 'rain' || currentTheme === 'storm') {
        bgCtx.globalAlpha = 0.5;
        bgCtx.lineWidth = 1.5;
        bgCtx.beginPath(); bgCtx.moveTo(p.x, p.y); bgCtx.lineTo(p.x + p.sx, p.y + p.l); bgCtx.stroke();
        p.y += p.sy; p.x += p.sx;
        if (p.y > h) { p.y = -20; p.x = Math.random()*w + 100; }
      } 
      else if (currentTheme === 'snow') {
        bgCtx.globalAlpha = 0.8;
        bgCtx.beginPath(); bgCtx.arc(p.x + Math.sin(p.a)*10, p.y, p.r, 0, Math.PI*2); bgCtx.fill();
        p.y += p.sy; p.a += 0.02;
        if (p.y > h) { p.y = -10; p.x = Math.random()*w; }
      }
      else if (currentTheme === 'cloudy') {
        bgCtx.globalAlpha = p.o;
        bgCtx.beginPath(); bgCtx.arc(p.x, p.y, p.r, 0, Math.PI*2); bgCtx.fill();
        p.x += p.sx;
        if(p.x - p.r > w) { p.x = -p.r; }
      }
    });

    bgCtx.globalAlpha = 1.0;
    animFrameId = requestAnimationFrame(drawParticles);
  }
  // --- END CANVAS SYSTEM ---

  async function searchPlaces(q){
    if(!q) return [];
    const url = `/api/nominatim/search?format=json&limit=5&addressdetails=1&q=${encodeURIComponent(q)}`;
    const r = await fetch(url, {headers:{'Accept-Language':navigator.language}});
    if(!r.ok) return [];
    return r.json();
  }

  function applyUnits(){
    btnUnits.textContent = state.units==='metric' ? "¬∞C" : "¬∞F";
    const uHidden = document.getElementById('unitsHidden');
    if(uHidden) uHidden.value = state.units;
    if(state.lat && state.lon) loadWeather(state.lat, state.lon, state.name);
    localStorage.setItem('pokeweather:units', JSON.stringify({units:state.units}));
  }

  async function loadWeather(lat, lon, name){
    state.lat = +lat; state.lon = +lon; state.name = name || state.name || `${lat.toFixed(3)}, ${lon.toFixed(3)}`;
    $('#locChip').textContent = state.name;
    const tu = state.units==='metric' ? "celsius" : "fahrenheit";
    const wu = state.units==='metric' ? "kmh" : "mph";
    
    const url = new URL("/api/weather", location.origin);
    url.searchParams.set('latitude', lat); url.searchParams.set('longitude', lon);
    url.searchParams.set('current', 'temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,weather_code,wind_speed_10m,wind_direction_10m,pressure_msl');
    url.searchParams.set('hourly', 'temperature_2m,apparent_temperature,precipitation_probability,precipitation,weather_code,wind_speed_10m');
    url.searchParams.set('daily', 'weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,uv_index_max');
    url.searchParams.set('timezone', 'auto'); url.searchParams.set('forecast_days', '7');
    url.searchParams.set('temperature_unit', tu); url.searchParams.set('windspeed_unit', wu);

    $('.current').classList.add('loading');
    try{
      const res = await fetch(url.toString());
      if(!res.ok) throw new Error('Weather error');
      const data = await res.json();
      localStorage.setItem('pokeweather:last', JSON.stringify({when:Date.now(), state, data}));
      render(data);
    }catch(e){
      const cached = JSON.parse(localStorage.getItem('pokeweather:last')||'null');
      if(cached) { render(cached.data); }
      else alert('Could not load weather data.');
    }finally{
      $('.current').classList.remove('loading');
    }
  }

  function render(d){
    const c = d.current; const daily = d.daily; const hourly = d.hourly;
    
    // Update Background based on weather state
    updateBackground(c.weather_code, c.is_day);

    $('#currIcon').textContent = weatherIcon(c.weather_code, c.is_day);
    $('#currTemp').textContent = fmt(c.temperature_2m, '¬∞');
    $('#currDesc').textContent = weatherText(c.weather_code);
    $('#currFeels').textContent = fmt(c.apparent_temperature, '¬∞');
    
    $('#currWind').textContent = `${fmt(c.wind_speed_10m)} ${state.units==='metric'?'km/h':'mph'}`;
    $('#currHum').textContent = fmt(c.relative_humidity_2m, '%');
    $('#currPress').textContent = fmt(c.pressure_msl, ' hPa');
    $('#sunrise').textContent = fmtTime(daily.sunrise[0]);
    $('#sunset').textContent = fmtTime(daily.sunset[0]);
    $('#uv').textContent = (daily.uv_index_max?.[0] ?? '‚Äî');
    
    const nowIndex = hourly.time.findIndex(t => Date.parse(t) > Date.now());
    const popNext = hourly.precipitation_probability?.[nowIndex] ?? hourly.precipitation_probability?.[0] ?? null;
    $('#pop').textContent = popNext==null ? '‚Äî' : popNext + "%";

    // Hourly
    const H = $('#hours'); H.innerHTML = '';
    const start = nowIndex > 0 ? nowIndex - 1 : 0; 
    const end = Math.min(start + 24, hourly.time.length);
    for(let i=start; i<end; i++){
      const el = document.createElement('div');
      el.className = 'hour-item';
      const t = new Date(hourly.time[i]).toLocaleTimeString([], {hour:'numeric', hour12:true}).replace(/\s/g,'');
      el.innerHTML = `
        <div class="time">${t}</div>
        <div class="icon">${weatherIcon(hourly.weather_code[i], 1)}</div>
        <div class="temp">${fmt(hourly.temperature_2m[i], '¬∞')}</div>
        <div class="pop">${(hourly.precipitation_probability?.[i] || '') ? hourly.precipitation_probability[i]+'%' : ''}</div>
      `;
      H.appendChild(el);
    }

    // Chart
    drawChart($('#chart'), hourly.temperature_2m.slice(start, end));

    // Daily
    const D = $('#days'); D.innerHTML = '';
    for(let i=0; i<daily.time.length; i++){
      const row = document.createElement('div'); row.className = 'day-row';
      const dt = i===0 ? 'Today' : fmtDay(daily.time[i]);
      row.innerHTML = `
        <div>${dt.substring(0,3)}</div>
        <div class="icon">${weatherIcon(daily.weather_code[i], 1)}</div>
        <div class="desc">${weatherText(daily.weather_code[i])}</div>
        <div class="hi">${fmt(daily.temperature_2m_max[i], '¬∞')}</div>
        <div class="lo">${fmt(daily.temperature_2m_min[i], '¬∞')}</div>
      `;
      D.appendChild(row);
    }
  }

  // Improved native-feel smooth line chart
  function drawChart(canvas, ys){
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * dpr; 
    canvas.height = rect.height * dpr;
    ctx.scale(dpr, dpr);
    
    const w = rect.width, h = rect.height;
    const min = Math.min(...ys), max = Math.max(...ys), pad = 15; 
    const xstep = w / (ys.length - 1);
    const ymap = v => { if(max===min) return h/2; return h - pad - ((v - min) / (max - min)) * (h - 2*pad); };
    
    ctx.clearRect(0, 0, w, h);

    // Gradient Fill under the line
    const grad = ctx.createLinearGradient(0, 0, 0, h);
    grad.addColorStop(0, 'rgba(255,255,255,0.4)');
    grad.addColorStop(1, 'rgba(255,255,255,0.0)');
    
    ctx.beginPath();
    ctx.moveTo(0, h);
    ctx.lineTo(0, ymap(ys[0]));
    
    // Draw smooth curve using quadratic bezier
    for(let i=0; i<ys.length-1; i++){
       const xMid = (i*xstep + (i+1)*xstep)/2;
       const yMid = (ymap(ys[i]) + ymap(ys[i+1]))/2;
       ctx.quadraticCurveTo(i*xstep, ymap(ys[i]), xMid, yMid);
    }
    ctx.lineTo((ys.length-1)*xstep, ymap(ys[ys.length-1]));
    ctx.lineTo(w, h);
    ctx.fillStyle = grad;
    ctx.fill();

    // Line itself
    ctx.lineWidth = 3; 
    ctx.strokeStyle = 'rgba(255,255,255,0.9)';
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.beginPath(); 
    ctx.moveTo(0, ymap(ys[0]));
    for(let i=0; i<ys.length-1; i++){
       const xMid = (i*xstep + (i+1)*xstep)/2;
       const yMid = (ymap(ys[i]) + ymap(ys[i+1]))/2;
       ctx.quadraticCurveTo(i*xstep, ymap(ys[i]), xMid, yMid);
    }
    ctx.lineTo((ys.length-1)*xstep, ymap(ys[ys.length-1]));
    ctx.stroke();

    // Points
    ctx.fillStyle = '#ffffff';
    ys.forEach((v,i) => {
      ctx.beginPath();
      ctx.arc(i*xstep, ymap(v), 4, 0, Math.PI*2);
      ctx.fill();
    });
  }

  btnUnits.addEventListener('click', () => {
    state.units = state.units==='metric' ? 'imperial' : 'metric';
    applyUnits();
  });

  $('#btnGeo').addEventListener('click', () => {
    if(!navigator.geolocation) { alert('Geolocation not supported'); return; }
    navigator.geolocation.getCurrentPosition(p => {
      reverseName(p.coords.latitude, p.coords.longitude).then(n => loadWeather(p.coords.latitude, p.coords.longitude, n));
    }, e => alert('Location denied'));
  });

  function reverseName(lat, lon){
    const u = `/api/nominatim/reverse?format=jsonv2&lat=${lat}&lon=${lon}`;
    return fetch(u).then(r => r.ok ? r.json() : null).then(j => j?.display_name?.split(',').slice(0,2).join(', ')||`${lat.toFixed(3)},${lon.toFixed(3)}`);
  }

  const suggest = $('#suggest');
  $('#q').addEventListener('input', debounce(async(e) => {
    const v = e.target.value.trim(); if(!v) { suggest.style.display='none'; return; }
    const list = await searchPlaces(v); suggest.innerHTML='';
    list.forEach(item => {
      const b = document.createElement('button'); b.type='button';
      b.textContent = item.display_name.split(',').slice(0,3).join(', ');
      b.addEventListener('click', () => { selectPlace(item) });
      suggest.appendChild(b);
    });
    if(list.length) suggest.style.display='block'; else suggest.style.display='none';
  }, 300));

  function selectPlace(item){
    suggest.style.display='none';
    $('#q').value = item.display_name.split(',').slice(0,2).join(', ');
    loadWeather(item.lat, item.lon, item.display_name.split(',').slice(0,2).join(', '));
  }

  const form = document.getElementById('searchForm');
  form.addEventListener('submit', (e) => { e.preventDefault(); goSearch(); });

  function goSearch(){
    const v = $('#q').value.trim();
    if(!v) return;
    const latlon = v.match(/^\s*(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)\s*$/);
    if(latlon){
      const lat = +latlon[1], lon = +latlon[2];
      reverseName(lat, lon).then(n => loadWeather(lat, lon, n));
      return;
    }
    if (window.__SSR_ROUTE__) {
      const u = state.units==='metric' ? 'metric' : 'imperial';
      const url = new URL(window.__SSR_ROUTE__, location.origin);
      url.searchParams.set('q', v); url.searchParams.set('units', u);
      location.href = url.toString();
      return;
    }
    searchPlaces(v).then(list => {
      if(list[0]) selectPlace(list[0]);
      else alert('No results found.');
    });
  }

  $('#btnShare').addEventListener('click', async e => {
    e.preventDefault();
    const url = new URL(location.href);
    if(state.lat && state.lon) { url.searchParams.set('lat', state.lat); url.searchParams.set('lon', state.lon); url.searchParams.set('name', state.name); }
    try{
      if(navigator.share) await navigator.share({title:'PokeWeather', text:`${state.name}: ${$('#currTemp').textContent} ${$('#currDesc').textContent}`, url:url.toString()});
      else { await navigator.clipboard.writeText(url.toString()); alert('Link copied!'); }
    }catch{}
  });

  function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); } }

  (function init(){
    const uHidden = document.getElementById('unitsHidden');
    if(uHidden) uHidden.value = state.units;

    // Apply basic background immediately if SSR info is present
    if (window.__SSR__ && window.__SSR__.current) {
        updateBackground(window.__SSR__.current.weather_code, window.__SSR__.current.is_day);
    }

    if (window.__SSR__ && typeof window.__SSR__.lat === "number") {
      try {
        localStorage.setItem('pokeweather:last', JSON.stringify({
          when: Date.now(),
          state: { lat: window.__SSR__.lat, lon: window.__SSR__.lon, name: window.__SSR__.name, units: state.units },
          data: { current: window.__SSR__.current || {}, daily: window.__SSR__.daily || {}, hourly: window.__SSR__.hourly || {} }
        }));
      } catch {}
      loadWeather(window.__SSR__.lat, window.__SSR__.lon, window.__SSR__.name);
      return;
    }

    const sp = new URLSearchParams(location.search);
    const lat = sp.get('lat'), lon = sp.get('lon'), name = sp.get('name');
    if(lat && lon) { loadWeather(+lat, +lon, name); return; }
    
    const cached = JSON.parse(localStorage.getItem('pokeweather:last')||'null');
    if(cached) { 
      state.units = cached.state?.units || state.units; 
      btnUnits.textContent = state.units==='metric' ? "¬∞C" : "¬∞F"; 
      if(uHidden) uHidden.value = state.units; 
      loadWeather(cached.state.lat, cached.state.lon, cached.state.name); 
      return; 
    }
    
    if(navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        p => { reverseName(p.coords.latitude, p.coords.longitude).then(n => loadWeather(p.coords.latitude, p.coords.longitude, n)) },
        () => {}
      );
    }
  })();
</script>
</body>
</html>