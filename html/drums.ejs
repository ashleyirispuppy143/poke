<!--

    This Source Code Form is subject to the terms of the GNU General Public License:

    Copyright (C) 2021-2026 Poke (https://codeberg.org/ashley/poke)
    
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program. If not, see https://www.gnu.org/licenses/.
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Poke Drums</title>
     <meta content="website" property="og:type">
    <meta content="PokeDrums" property="og:title">
    <meta content="8-void drum synth with 16/32-step sequencer" property="twitter:description">
  <meta property="og:image" content="/static/poke.webp">
  <meta content="summary_large_image" name="twitter:card">

  <meta name="theme-color" content="#111111" />
  <style>
    :root {
      --bg-app: #09090b;
      --bg-panel: #141417;
      --bg-panel-border: #27272a;
      --bg-darker: #0c0c0e;

      --primary: #8b5cf6;
      --accent: #06b6d4;
      --danger: #f43f5e;
      --success: #10b981;

      --gradient-brand: linear-gradient(135deg, var(--primary), var(--accent));
      --text-main: #e4e4e7;
      --text-muted: #a1a1aa;

      --radius: 8px; /* Sharper corners for pro feel */
      --header-height: 64px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      background-color: var(--bg-app);
      /* Technical Grid Background */
      background-image:
        linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
      background-size: 20px 20px;
      color: var(--text-main);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* --- PROFESSIONAL HEADER --- */
    header {
      height: var(--header-height);
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #141417;
      border-bottom: 1px solid var(--bg-panel-border);
      z-index: 50;
      user-select: none;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .brand { display: flex; align-items: center; gap: 16px; }

    .logo-img {
      height: 32px;
      width: auto;
      display: block;
      filter: drop-shadow(0 0 8px rgba(139, 92, 246, 0.4));
    }

    .header-controls {
      display: flex; align-items: center; gap: 20px;
      background: #09090b;
      padding: 6px 8px 6px 20px;
      border: 1px solid var(--bg-panel-border);
      border-radius: 6px;
    }

    .bpm-box { display: flex; flex-direction: column; align-items: flex-end; line-height: 1; }
    .bpm-val { font-family: 'Courier New', monospace; font-weight: 700; font-size: 16px; color: var(--accent); }
    .bpm-label { font-size: 9px; font-weight: 600; color: var(--text-muted); letter-spacing: 1px; margin-top: 2px; }

    /* --- LAYOUT --- */
    main {
      flex: 1;
      display: grid;
      grid-template-columns: 320px 1fr;
      grid-template-rows: auto 1fr;
      gap: 1px; /* Gap creates the border lines */
      background: var(--bg-panel-border); /* Lines color */
      overflow: hidden;
    }

    .panel {
      background: var(--bg-panel);
      display: flex;
      flex-direction: column;
      padding: 16px;
      overflow: hidden;
    }

    /* --- CONTROLS --- */
    h2 {
      font-size: 11px; text-transform: uppercase; letter-spacing: 1px;
      color: var(--text-muted); margin: 0 0 12px 0; font-weight: 700;
      display: flex; align-items: center; gap: 8px;
    }
    h2::after { content:''; flex:1; height:1px; background: var(--bg-panel-border); }

    label { font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 6px; font-weight: 600; text-transform: uppercase; }

    button {
      cursor: pointer; border: none; border-radius: 4px;
      padding: 0 16px; height: 32px; font-size: 12px; font-weight: 600;
      transition: all 0.1s; display: inline-flex; align-items: center; justify-content: center;
      font-family: inherit; letter-spacing: 0.3px; text-transform: uppercase;
    }

    button.primary {
      background: var(--primary); color: white;
    }
    button.primary:hover { background: #7c3aed; }
    button.primary:active { transform: translateY(1px); }

    button.secondary { background: #27272a; color: var(--text-main); border: 1px solid #3f3f46; }
    button.secondary:hover { background: #3f3f46; border-color: #52525b; }

    button.danger { background: rgba(244, 63, 94, 0.1); color: var(--danger); border: 1px solid rgba(244, 63, 94, 0.3); }
    button.danger:hover { background: rgba(244, 63, 94, 0.2); }

    button.toggle { background: #27272a; color: var(--text-muted); border: 1px solid #3f3f46; }
    button.toggle.active { background: var(--success); color: #000; border-color: var(--success); }

    button.rec-active {
        background: var(--danger) !important; color: white !important;
        box-shadow: 0 0 15px var(--danger); animation: pulse 1.5s infinite; border: none;
    }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

    /* --- SLIDERS --- */
    input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; height: 20px; cursor: pointer; margin: 0; }
    input[type=range]:focus { outline: none; }
    input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #3f3f46; border-radius: 2px; }
    input[type=range]::-moz-range-track { width: 100%; height: 4px; background: #3f3f46; border-radius: 2px; }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%;
      background: #e4e4e7; margin-top: -4px; box-shadow: 0 1px 3px rgba(0,0,0,0.5);
      transition: transform 0.1s;
    }
    input[type=range]:hover::-webkit-slider-thumb { transform: scale(1.2); background: var(--primary); }
    input[type=range]::-moz-range-thumb {
      height: 12px; width: 12px; border-radius: 50%; background: #e4e4e7; border: none;
    }

    select, input[type="number"] {
      background: #09090b; color: white; border: 1px solid #3f3f46;
      padding: 0 10px; height: 32px; border-radius: 4px; font-family: inherit; font-size: 12px; outline: none; width: 100%;
    }
    select:focus, input:focus { border-color: var(--primary); }

    /* --- PANELS --- */
    .controls-panel { grid-column: 1; grid-row: 1; gap: 16px; min-height: 240px; }
    .row { display: flex; gap: 12px; }
    .col { display: flex; flex-direction: column; gap: 8px; flex: 1; }

    .mixer-panel { grid-column: 1; grid-row: 2; overflow-y: auto; background: #111113; }
    .fader-row {
      display: grid; grid-template-columns: 40px 1fr; align-items: center; gap: 12px;
      padding: 6px 0; border-bottom: 1px solid #1f1f22;
    }
    .fader-row span { font-size: 10px; font-weight: 700; color: var(--text-muted); font-family: monospace; }
    .fader-row span.lit { color: var(--accent); text-shadow: 0 0 8px var(--accent); }

    .stage-panel {
      grid-column: 2; grid-row: 1 / 3;
      display: grid; grid-template-rows: auto 1fr; gap: 1px;
      background: var(--bg-panel-border); padding: 0;
    }

    .pads-area { padding: 20px; background: #141417; display: flex; justify-content: center; }
    .pads-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; max-width: 800px; width: 100%; }

    .pad {
      aspect-ratio: 1; background: #1f1f22;
      border: 1px solid #27272a; border-radius: 4px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      cursor: pointer; user-select: none; position: relative; overflow: hidden;
      transition: all 0.05s;
    }
    .pad:hover { background: #27272a; border-color: #3f3f46; }
    .pad.hit { background: var(--primary); border-color: var(--primary); box-shadow: 0 0 15px var(--primary); transform: translateY(2px); }
    .pad span.n { font-size: 12px; font-weight: 700; color: #fff; }
    .pad span.k { font-size: 9px; color: rgba(255,255,255,0.5); margin-top: 2px; }

    /* --- SEQUENCER --- */
    .sequencer-area {
      position: relative;
      background: #0c0c0e;
      overflow: hidden;
      display: flex; flex-direction: column;
    }

    /* Toolbar for Sequencer */
    .seq-toolbar {
      height: 40px; background: #141417; border-bottom: 1px solid var(--bg-panel-border);
      display: flex; align-items: center; justify-content: flex-end; padding: 0 16px;
    }

    .seq-scroll {
      flex: 1; overflow: auto; padding: 20px;
      scrollbar-width: thin; scrollbar-color: #333 #0c0c0e;
      scroll-behavior: smooth; /* Smooth scrolling for auto-follow */
    }

    .seq-grid {
      display: grid; grid-template-columns: 80px repeat(var(--steps, 16), 30px); gap: 2px;
    }

    .track-head {
      position: sticky; left: 0; z-index: 10; background: #0c0c0e;
      display: flex; align-items: center; font-size: 10px; font-weight: 700; color: var(--text-muted);
      text-transform: uppercase; border-right: 1px solid var(--bg-panel-border); margin-right: 6px;
      height: 28px; font-family: monospace;
    }
    .track-head.lit { color: var(--accent); }

    .step {
      height: 28px; background: #1a1a1d; border-radius: 2px; cursor: pointer;
      border: 1px solid transparent;
    }
    /* Bar Markers (every 4) */
    .step:nth-child(4n + 2), .step:nth-child(4n + 3), .step:nth-child(4n + 4), .step:nth-child(4n + 5) { background: #202024; }

    .step:hover { border-color: #555; }
    .step.active { background: var(--accent); box-shadow: 0 0 8px rgba(6, 182, 212, 0.3); }
    .step.playing { border: 1px solid #fff; z-index: 5; }
    .step.active.playing { background: #fff; filter: brightness(1.2); }

    /* FOOTER */
    footer {
      height: 48px; background: #000; border-top: 1px solid var(--bg-panel-border);
      position: relative; flex-shrink: 0;
    }
    canvas#vis { width: 100%; height: 100%; opacity: 0.6; }
    .status-badge {
      position: absolute; bottom: 14px; right: 24px;
      font-family: monospace; font-size: 10px; color: var(--text-muted);
      background: #111; padding: 2px 8px; border-radius: 4px; border: 1px solid #333;
    }

    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px);
      display: none; align-items: center; justify-content: center; z-index: 100;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: #18181b; border: 1px solid #3f3f46;
      padding: 24px; border-radius: 8px; width: 340px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.8);
    }
    .modal-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; }

    @media (max-width: 1000px) {
      main { grid-template-columns: 1fr; grid-template-rows: auto auto auto; overflow-y: auto; padding: 0; gap: 0; }
      .stage-panel { grid-row: 1; grid-column: 1; min-height: 400px; border-bottom: 1px solid #333; }
      .controls-panel { grid-row: 2; padding: 24px; border-bottom: 1px solid #333; }
      .mixer-panel { grid-row: 3; padding: 24px; }
      header { padding: 0 16px; }
    }
  </style>
</head>
<body>

  <header>
    <div class="brand">
      <img src="https://poketube.fun/css/logo-poke.svg?v=5" alt="Poke" class="logo-img">
    </div>

    <div class="header-controls">
      <div class="bpm-box">
        <div class="bpm-val" id="bpmDisplay">120</div>
        <div class="bpm-label">BPM</div>
      </div>
      <div style="width:1px; height:24px; background:#333; margin:0 4px;"></div>
      <button id="playBtn" class="primary" style="width: 100px;">
        <span style="margin-right:6px;">▶</span> PLAY
      </button>
    </div>
  </header>

  <main>
    <section class="panel controls-panel">
      <h2>Project Settings</h2>
      <div class="row">
        <div class="col">
          <label>Tempo</label>
          <input id="bpm" type="range" min="40" max="300" value="120">
        </div>
        <div class="col">
          <label>Swing</label>
          <input id="swing" type="range" min="0" max="0.5" step="0.01" value="0">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Pattern Length</label>
          <select id="lengthSelector">
            <option value="8">8 Steps</option>
            <option value="16" selected>16 Steps</option>
            <option value="32">32 Steps</option>
            <option value="64">64 Steps</option>
            <option value="custom" style="color:var(--accent)">Custom...</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:auto">
        <button id="clearBtn" class="secondary" style="flex:1">Clear</button>
        <button id="randomBtn" class="secondary" style="flex:1">Random</button>
        <button id="recBtn" class="secondary" style="width:40px; color:var(--danger); font-size:16px;" title="Record">●</button>
      </div>
    </section>

    <section class="panel mixer-panel">
      <h2>Mixer</h2>
      <div id="mixerList"></div>
    </section>

    <section class="panel stage-panel">
      <div class="pads-area">
        <div class="pads-grid" id="pads"></div>
      </div>
      <div class="sequencer-area">
        <div class="seq-toolbar">
           <button id="autoFollowBtn" class="toggle active" style="height:24px; font-size:10px;">
             Auto-Follow: ON
           </button>
        </div>
        <div class="seq-scroll" id="seqContainer">
          <div class="seq-grid" id="seq"></div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <canvas id="vis"></canvas>
    <div class="status-badge" id="status">READY</div>
  </footer>

  <div class="modal-overlay" id="customModal">
    <div class="modal">
      <h2 style="color:white; border:none; margin-bottom: 8px;">Custom Grid Size</h2>
      <p style="font-size:12px; color:var(--text-muted); margin-bottom:20px;">Enter total steps (4 - 512):</p>
      <input type="number" id="customStepsInput" min="4" max="512" value="48">
      <div class="modal-actions">
        <button class="secondary" id="cancelCustom">Cancel</button>
        <button class="primary" id="confirmCustom">Set Grid</button>
      </div>
    </div>
  </div>

<script>
    ;(() => {
      const $ = s => document.querySelector(s)

      const state = {
        bpm: 120,
        swing: 0,
        steps: 16,
        playing: false,
        recording: false,
        autoFollow: true,
        voices: ['kick', 'snare', 'hh', 'oh', 'clap', 'tom', 'rim', 'crash'],
        keyMap: {q:'kick',w:'snare',e:'clap',r:'hh',t:'oh',y:'tom',u:'rim',i:'crash'},
        vol: {kick:.9, snare:.9, hh:.8, oh:.7, clap:.9, tom:.8, rim:.7, crash:.7},
        grid: {}
      }

      // Init Grid
      state.voices.forEach(v => state.grid[v] = Array(512).fill(false))

      // Audio Ctx
      let ctx, master, analyser, limiter
      let nextTime = 0, currentStep = 0, timerID = null
      let recorder = null, chunks = []
      const gains = {}

      const els = {
        bpm: $('#bpm'), swing: $('#swing'), len: $('#lengthSelector'),
        mixer: $('#mixerList'), pads: $('#pads'), seq: $('#seq'), seqCont: $('#seqContainer'),
        play: $('#playBtn'), bpmDisp: $('#bpmDisplay'), status: $('#status'),
        modal: $('#customModal'), customIn: $('#customStepsInput'),
        confirmCust: $('#confirmCustom'), cancelCust: $('#cancelCustom'),
        rec: $('#recBtn'), follow: $('#autoFollowBtn')
      }

      // --- AUDIO ENGINE ---
      function initAudio() {
        if (ctx) return
        ctx = new (window.AudioContext || window.webkitAudioContext)()

        master = ctx.createGain(); master.gain.value = 0.9
        limiter = ctx.createDynamicsCompressor()
        limiter.threshold.value = -1; limiter.ratio.value = 20
        analyser = ctx.createAnalyser(); analyser.fftSize = 128

        master.connect(limiter); limiter.connect(analyser); analyser.connect(ctx.destination)

        state.voices.forEach(v => {
          gains[v] = ctx.createGain()
          gains[v].gain.value = state.vol[v]
          gains[v].connect(master)
        })
        visualize()
      }

      function ensureNoise() {
        if(window._n) return window._n
        const b=ctx.createBuffer(1, ctx.sampleRate, ctx.sampleRate)
        const d=b.getChannelData(0)
        for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1
        return window._n=b
      }

      function playVoice(v, t) {
        if(!ctx) initAudio()
        t = t || ctx.currentTime
        const out = gains[v]

        // Flash UI (Visual Feedback)
        if(t - ctx.currentTime < 0.1) requestAnimationFrame(() => flashTrack(v))
        else setTimeout(() => requestAnimationFrame(() => flashTrack(v)), (t - ctx.currentTime)*1000)

        // Simple Synth Models
        if(v==='kick'){
          const o=ctx.createOscillator(), g=ctx.createGain()
          o.frequency.setValueAtTime(150,t); o.frequency.exponentialRampToValueAtTime(50,t+0.1)
          g.gain.setValueAtTime(1,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.4)
          o.connect(g); g.connect(out); o.start(t); o.stop(t+0.4)
        } else if(v==='snare'){
          const n=ctx.createBufferSource(), f=ctx.createBiquadFilter(), g=ctx.createGain()
          n.buffer=ensureNoise(); f.type='highpass'; f.frequency.value=1000
          g.gain.setValueAtTime(1,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.2)
          n.connect(f); f.connect(g); g.connect(out); n.start(t); n.stop(t+0.2)
          const o=ctx.createOscillator(), og=ctx.createGain()
          o.type='triangle'; o.frequency.setValueAtTime(180,t)
          og.gain.setValueAtTime(0.5,t); og.gain.exponentialRampToValueAtTime(0.01,t+0.1)
          o.connect(og); og.connect(out); o.start(t); o.stop(t+0.1)
        } else if(v==='hh'){
          const n=ctx.createBufferSource(), f=ctx.createBiquadFilter(), g=ctx.createGain()
          n.buffer=ensureNoise(); f.type='highpass'; f.frequency.value=7000
          g.gain.setValueAtTime(0.7,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.05)
          n.connect(f); f.connect(g); g.connect(out); n.start(t); n.stop(t+0.06)
        } else {
          const n=ctx.createBufferSource(), f=ctx.createBiquadFilter(), g=ctx.createGain()
          n.buffer=ensureNoise(); f.type='lowpass'; f.frequency.value = v==='tom'?400:3000
          g.gain.setValueAtTime(0.6,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.25)
          n.connect(f); f.connect(g); g.connect(out); n.start(t); n.stop(t+0.26)
        }
      }

      function flashTrack(v) {
        const ids = [`lab-${v}`, `mix-${v}`, `pad-${v}`]
        ids.forEach(id => {
            const el = document.getElementById(id)
            if(el) {
                const cls = id.startsWith('pad') ? 'hit' : 'lit'
                el.classList.add(cls)
                setTimeout(()=>el.classList.remove(cls), 100)
            }
        })
      }

      function visualize() {
        const c = $('#vis'), cc = c.getContext('2d')
        const w = c.width = c.offsetWidth, h = c.height = c.offsetHeight
        const d = new Uint8Array(analyser.frequencyBinCount)
        function loop() {
          requestAnimationFrame(loop)
          analyser.getByteFrequencyData(d)
          cc.clearRect(0,0,w,h)
          const bw = (w/d.length)*2.5; let x=0
          for(let i=0; i<d.length; i++){
             const bh = (d[i]/255)*h
             cc.fillStyle = `hsl(${i*4 + 250}, 80%, 60%)`
             cc.fillRect(x, h-bh, bw, bh)
             x+=bw+1
          }
        }
        loop()
      }

      function scheduler() {
        const secPerBeat = 60 / state.bpm
        const stepTime = secPerBeat / 4
        const lookahead = 0.1

        while (nextTime < ctx.currentTime + lookahead) {
          const s = currentStep % state.steps
          state.voices.forEach(v => { if(state.grid[v][s]) playVoice(v, nextTime) })

          const drawStep = s
          requestAnimationFrame(() => {
            // UI Updates
            document.querySelectorAll('.step.playing').forEach(el => el.classList.remove('playing'))
            const cols = document.querySelectorAll(`.step[data-col="${drawStep}"]`)
            cols.forEach(el => el.classList.add('playing'))

            // Auto Follow Logic
            if(state.autoFollow && state.playing) {
                // Find the column element
                const colEl = cols[0]
                if(colEl) {
                    const container = els.seqCont
                    const elLeft = colEl.offsetLeft
                    const elRight = elLeft + colEl.offsetWidth
                    const viewLeft = container.scrollLeft
                    const viewRight = viewLeft + container.offsetWidth

                    // If element is out of view (or close to edge)
                    if (elRight > viewRight || elLeft < viewLeft) {
                        // Scroll to center it if possible
                        container.scrollLeft = elLeft - 20
                    }
                }
            }
          })

          let swing = 0
          if(state.swing > 0 && s % 2 !== 0) swing = stepTime * state.swing
          nextTime += stepTime + swing
          currentStep++
        }
      }

      function togglePlay() {
        if(!ctx) initAudio()
        state.playing = !state.playing
        if(state.playing) {
           nextTime = ctx.currentTime
           currentStep = 0
           timerID = setInterval(scheduler, 25)
           els.play.innerHTML = '<span style="margin-right:6px;">■</span> STOP'
           els.play.classList.add('danger')
           els.status.textContent = state.recording ? "RECORDING..." : "PLAYING"
        } else {
           clearInterval(timerID)
           els.play.innerHTML = '<span style="margin-right:6px;">▶</span> PLAY'
           els.play.classList.remove('danger')
           els.status.textContent = "STOPPED"
           document.querySelectorAll('.step.playing').forEach(el => el.classList.remove('playing'))
        }
      }

      // --- RECORDING ---
      els.rec.onclick = () => {
         if(!ctx) initAudio()
         if(!state.recording) {
            const dest = ctx.createMediaStreamDestination()
            master.connect(dest)
            try { recorder = new MediaRecorder(dest.stream) } catch { alert("Not supported"); return }

            recorder.ondataavailable = e => chunks.push(e.data)
            recorder.onstop = () => {
                const blob = new Blob(chunks, {'type': 'audio/webm; codecs=opus'})
                const url = URL.createObjectURL(blob)
                const a = document.createElement('a')
                a.href = url; a.download = 'pokedrums-record.webm'; a.click()
                chunks = []
            }
            recorder.start()
            state.recording = true
            els.rec.classList.add('rec-active')
            els.rec.innerHTML = '■'
            els.status.textContent = "RECORDING..."
         } else {
            if(recorder) recorder.stop()
            state.recording = false
            els.rec.classList.remove('rec-active')
            els.rec.innerHTML = '●'
            els.status.textContent = "RECORDING SAVED"
         }
      }

      // --- AUTO FOLLOW TOGGLE ---
      els.follow.onclick = () => {
          state.autoFollow = !state.autoFollow
          els.follow.classList.toggle('active', state.autoFollow)
          els.follow.textContent = `Auto-Follow: ${state.autoFollow ? 'ON' : 'OFF'}`
      }

      function buildUI() {
        els.mixer.innerHTML = ''
        state.voices.forEach(v => {
           const r = document.createElement('div'); r.className='fader-row'
           r.innerHTML = `<span id="mix-${v}">${v.substring(0,3)}</span>
                          <input type="range" min="0" max="1" step="0.05" value="${state.vol[v]}">`
           r.querySelector('input').oninput = function() {
               state.vol[v] = +this.value
               if(gains[v]) gains[v].gain.value = state.vol[v]
           }
           els.mixer.appendChild(r)
        })

        els.pads.innerHTML = ''
        state.voices.forEach(v => {
           const p = document.createElement('div'); p.className='pad'; p.id=`pad-${v}`
           const k = Object.keys(state.keyMap).find(key => state.keyMap[key]===v) || ''
           p.innerHTML = `<span class="n">${v.toUpperCase()}</span><span class="k">${k.toUpperCase()}</span>`
           p.onmousedown = () => playVoice(v)
           els.pads.appendChild(p)
        })
        renderSeq()
      }

      function renderSeq() {
        els.seq.style.setProperty('--steps', state.steps)
        els.seq.innerHTML = ''

        // Header Row
        const corner = document.createElement('div'); corner.className='track-head'; corner.style.border='none'; els.seq.appendChild(corner)
        for(let i=0; i<state.steps; i++){
            const n = document.createElement('div')
            n.style.textAlign='center'; n.style.fontSize='9px'; n.style.color='#444'; n.textContent = i+1
            els.seq.appendChild(n)
        }

        state.voices.forEach(v => {
           const lab = document.createElement('div'); lab.className='track-head'; lab.id=`lab-${v}`; lab.textContent=v
           els.seq.appendChild(lab)

           for(let i=0; i<state.steps; i++){
              const s = document.createElement('div'); s.className='step'
              if(state.grid[v][i]) s.classList.add('active')
              s.dataset.col = i
              s.onclick = () => {
                 state.grid[v][i] = !state.grid[v][i]
                 s.classList.toggle('active')
              }
              els.seq.appendChild(s)
           }
        })
      }

      els.play.onclick = togglePlay
      els.bpm.oninput = function() { state.bpm = +this.value; els.bpmDisp.innerText = state.bpm }
      els.swing.oninput = function() { state.swing = +this.value }

      els.len.onchange = (e) => {
         if(e.target.value === 'custom') els.modal.classList.add('open')
         else { state.steps = +e.target.value; renderSeq() }
      }

      els.cancelCust.onclick = () => { els.modal.classList.remove('open'); els.len.value = state.steps }
      els.confirmCust.onclick = () => {
         let val = +els.customIn.value
         if(val < 4) val=4; if(val>512) val=512
         state.steps = val
         els.modal.classList.remove('open')
         renderSeq()
      }

      $('#clearBtn').onclick = () => { state.voices.forEach(v => state.grid[v].fill(false)); renderSeq() }
      $('#randomBtn').onclick = () => { state.voices.forEach(v => { for(let i=0; i<state.steps; i++) state.grid[v][i] = Math.random() > 0.85 }); renderSeq() }

      window.addEventListener('keydown', e => {
         if(e.repeat) return
         if(e.key === ' ') { e.preventDefault(); togglePlay(); return }
         const v = state.keyMap[e.key.toLowerCase()]
         if(v) playVoice(v)
      })

      buildUI()
    })()
</script>
</body>
</html>
