 <!--

    This Source Code Form is subject to the terms of the GNU General Public License:

    Copyright (C) 2021-2026 Poke (https://codeberg.org/ashley/poke)
    
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program. If not, see https://www.gnu.org/licenses/.
--->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" href="css/yt-ukraine.svg" type="image/svg+xml" />
  <meta name="theme-color" content="#0c0c0c" />
  <meta name="description" content="Poke! Calendar â€” zero-JS calendar" />
  <meta property="og:title" content="Poke! Calendar" />
  <meta property="og:description" content="Navigate months without JavaScript needed" />
  <meta property="og:image" content="/static/poke.webp" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Poke! Calendar" />
  <meta name="twitter:image" content="/static/poke.webp" />
  <title>Poke! Calendar</title>

  <style>
    :root {
      /* Palette */
      --bg: #050505;
      --surface-1: #121212;
      --surface-2: #1e1e1e;
      --surface-glass: rgba(30, 30, 30, 0.65);
      --border: #333;
      
      --text-main: #f0f0f0;
      --text-muted: #a0a0a0;
      
      --accent: #8b5cf6; /* Violet */
      --accent-glow: rgba(139, 92, 246, 0.4);
      --accent-dark: #6d28d9;
      
      --today-bg: #2e1065;
      --today-border: #a78bfa;

      /* Spacing & Layout */
      --radius: 12px;
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      --font-body: system-ui, -apple-system, sans-serif;
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f8f9fa;
        --surface-1: #ffffff;
        --surface-2: #f1f3f5;
        --surface-glass: rgba(255, 255, 255, 0.7);
        --border: #dee2e6;
        --text-main: #212529;
        --text-muted: #6c757d;
        --accent: #6200ee;
        --accent-glow: rgba(98, 0, 238, 0.2);
        --accent-dark: #3700b3;
        --today-bg: #ede9fe;
        --today-border: #6200ee;
      }
    }

    /* Base Reset */
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      background-image: 
        radial-gradient(at 0% 0%, rgba(139, 92, 246, 0.15) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(56, 189, 248, 0.1) 0px, transparent 50%);
      background-attachment: fixed;
      color: var(--text-main);
      font-family: var(--font-body);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Navbar */
    .navbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 2rem;
      background: var(--surface-glass);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .brand img { height: 2rem; width: auto; display: block; }
    
    .year-info {
      display: flex;
      gap: 1.5rem;
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    .year-info span strong { color: var(--accent); }

    /* Main Container */
    .main-wrapper {
      width: min(100% - 2rem, 1000px);
      margin: 2rem auto;
      flex: 1;
    }

    .calendar-card {
      background: var(--surface-1);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      position: relative;
      overflow: hidden;
    }

    /* Controls Header */
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      gap: 1rem;
    }

    .month-title {
      font-size: 2rem;
      font-weight: 800;
      margin: 0;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--text-main), var(--text-muted));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .date-form {
      display: flex;
      gap: 0.5rem;
    }

    .picker-input {
      background: var(--surface-2);
      border: 1px solid var(--border);
      color: var(--text-main);
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      font-family: inherit;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.2s ease;
      cursor: pointer;
      border: none;
      font-size: 0.9rem;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
      box-shadow: 0 4px 12px var(--accent-glow);
    }
    .btn-primary:hover { background: var(--accent-dark); transform: translateY(-1px); }

    .btn-secondary {
      background: var(--surface-2);
      color: var(--text-main);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover { border-color: var(--accent); }

    /* Calendar Grid */
    .calendar-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 4px; /* Creates the gap */
      table-layout: fixed;
    }

    .calendar-table th {
      padding: 1rem 0;
      color: var(--text-muted);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .calendar-table td {
      height: clamp(80px, 10vw, 120px);
      vertical-align: top;
      background: var(--surface-2);
      border-radius: 8px;
      padding: 8px;
      transition: all 0.15s ease;
      position: relative;
      border: 1px solid transparent;
    }

    /* Day Number */
    .day-num {
      display: block;
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 4px;
    }

    /* Empty Cells */
    .calendar-table td:empty {
      background: transparent;
      pointer-events: none;
    }

    /* Interactive States (Only if has date) */
    .calendar-table td:not(:empty) { cursor: pointer; }
    .calendar-table td:not(:empty):hover {
      background: var(--surface-1);
      border-color: var(--accent);
      transform: scale(1.02);
      z-index: 2;
    }

    /* Today Modifier */
    .calendar-table td.today {
      background: var(--today-bg);
      border: 1px solid var(--today-border);
      color: var(--accent);
    }
    .calendar-table td.today .day-num { color: var(--accent); }

    /* Note Indicator (JS Feature) */
    .note-indicator {
      display: none; /* Hidden by default, shown by JS */
      width: 6px;
      height: 6px;
      background-color: var(--accent);
      border-radius: 50%;
      position: absolute;
      bottom: 10px;
      right: 10px;
      box-shadow: 0 0 8px var(--accent);
    }
    
    .calendar-table td.has-note .note-indicator { display: block; }
    
    /* Small text preview for no-js fallbacks if rendered server side (optional) */
    .note-preview {
        font-size: 0.7em;
        color: var(--text-muted);
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* Navigation Footer */
    .nav-footer {
      display: flex;
      justify-content: space-between;
      margin-top: 1.5rem;
    }

    /* Modal (Hidden by default, used for JS) */
    #note-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    #note-modal.open { opacity: 1; pointer-events: auto; }

    .modal-content {
      background: var(--surface-1);
      border: 1px solid var(--border);
      padding: 2rem;
      border-radius: var(--radius);
      width: min(90%, 400px);
      box-shadow: var(--shadow);
    }
    .modal-header { font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem; color: var(--accent); }
    .modal-textarea {
      width: 100%;
      height: 120px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      color: var(--text-main);
      padding: 0.5rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      resize: vertical;
    }
    .modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; }

    /* Mobile Adjustments */
    @media (max-width: 600px) {
      .year-info { width: 100%; justify-content: space-between; margin-top: 0.5rem; }
      .calendar-table td { height: 70px; padding: 4px; }
      .day-num { font-size: 0.85rem; }
      .month-title { font-size: 1.5rem; }
    }
  </style>
</head>
<body>

  <nav class="navbar">
    <a href="/" class="brand">
      <img src="/css/logo-poke.svg?v=5" alt="Poke Calendar Logo">
    </a>
    <div class="years">
      <div class="year-info">
        <span>Gregorian: <strong><%= year %></strong></span>
        <span>Islamic: <strong><%= islamicYear %></strong></span>
        <span>Persian: <strong><%= persianYear %></strong></span>
      </div>
    </div>
  </nav>

  <div class="main-wrapper">
    <div class="calendar-card">
      
      <div class="controls">
        <h2 class="month-title">
          <%= queryDate.toLocaleString('default', { month: 'long' }) %> <%= year %>
        </h2>
        
        <form action="/calendar" method="get" class="date-form">
          <input 
            type="month" 
            name="date" 
            value="<%= currentDate.toISOString().slice(0,7) %>" 
            class="picker-input" 
            aria-label="Select Month"
          />
          <button type="submit" class="btn btn-primary">Go</button>
        </form>
      </div>

      <table class="calendar-table" role="grid" aria-label="Monthly calendar">
        <thead>
          <tr>
            <th scope="col" abbr="Sunday">Sun</th>
            <th scope="col" abbr="Monday">Mon</th>
            <th scope="col" abbr="Tuesday">Tue</th>
            <th scope="col" abbr="Wednesday">Wed</th>
            <th scope="col" abbr="Thursday">Thu</th>
            <th scope="col" abbr="Friday">Fri</th>
            <th scope="col" abbr="Saturday">Sat</th>
          </tr>
        </thead>
        <tbody>
          <% days.forEach((day, idx) => { %>
            <% if (idx % 7 === 0) { %><tr><% } %>
              
              <% 
                const today = new Date();
                const isToday = day &&
                  day.getDate() === today.getDate() &&
                  day.getMonth() === today.getMonth() &&
                  day.getFullYear() === today.getFullYear();
                
                // Format date for JS Data Attribute (YYYY-MM-DD)
                // Use local time offset handling or simple string manipulation ensures ID consistency
                const dateStr = day ? 
                   day.getFullYear() + '-' + 
                   String(day.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(day.getDate()).padStart(2, '0') 
                   : '';
              %>

              <td 
                class="<%= isToday ? 'today' : '' %>" 
                data-date="<%= dateStr %>"
                <% if (day) { %> tabindex="0" role="gridcell" <% } %>
              >
                <% if (day) { %>
                  <span class="day-num"><%= day.getDate() %></span>
                  <div class="note-indicator" title="Has note"></div>
                  <% } %>
              </td>

            <% if (idx % 7 === 6) { %></tr><% } %>
          <% }); %>
        </tbody>
      </table>

      <div class="nav-footer">
        <a href="/calendar?date=<%= new Date(year, month - 1, 1).toISOString() %>" class="btn btn-secondary">
          &larr; Previous
        </a>
        <a href="/calendar?date=<%= new Date(year, month + 1, 1).toISOString() %>" class="btn btn-secondary">
          Next &rarr;
        </a>
      </div>

    </div>
  </div>

  <div id="note-modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header" id="modal-date-display">Date</div>
      <textarea id="note-text" class="modal-textarea" placeholder="Add a reminder or note for this day..."></textarea>
      <div class="modal-actions">
        <button id="close-modal" class="btn btn-secondary">Cancel</button>
        <button id="save-note" class="btn btn-primary">Save Note</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Elements
      const modal = document.getElementById('note-modal');
      const textarea = document.getElementById('note-text');
      const dateDisplay = document.getElementById('modal-date-display');
      const saveBtn = document.getElementById('save-note');
      const closeBtn = document.getElementById('close-modal');
      let activeDateKey = null;

       const updateIndicators = () => {
        document.querySelectorAll('td[data-date]').forEach(td => {
          const date = td.getAttribute('data-date');
          if (!date) return;
          
          const note = localStorage.getItem('poke_note_' + date);
          if (note && note.trim() !== "") {
            td.classList.add('has-note');
          } else {
            td.classList.remove('has-note');
          }
        });
      };
      
      updateIndicators();

      // 2. Event Delegation for Cell Clicks
      document.querySelector('.calendar-table tbody').addEventListener('click', (e) => {
        // Find closest TD
        const td = e.target.closest('td');
        if (!td || !td.getAttribute('data-date')) return;

        activeDateKey = td.getAttribute('data-date');
        
        // Load existing note
        const existingNote = localStorage.getItem('poke_note_' + activeDateKey) || '';
        textarea.value = existingNote;
        
        // Format Date for Header
        const dateObj = new Date(activeDateKey);
        dateDisplay.textContent = dateObj.toLocaleDateString(undefined, { 
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
        });

        // Show Modal
        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
        textarea.focus();
      });

      // 3. Save Logic
      saveBtn.addEventListener('click', () => {
        if (activeDateKey) {
          const text = textarea.value;
          if (text.trim() === "") {
            localStorage.removeItem('poke_note_' + activeDateKey);
          } else {
            localStorage.setItem('poke_note_' + activeDateKey, text);
          }
          updateIndicators();
          closeModal();
        }
      });

      // 4. Close Logic
      const closeModal = () => {
        modal.classList.remove('open');
        modal.setAttribute('aria-hidden', 'true');
        activeDateKey = null;
      };

      closeBtn.addEventListener('click', closeModal);
      
      // Close on background click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      // Keyboard Accessibility
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('open')) {
          closeModal();
        }
      });
      
      // Allow 'Enter' key on grid cells to open modal
      document.querySelectorAll('td[data-date]').forEach(td => {
        td.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') td.click();
        });
      });
    });
  </script>
</body>
</html>