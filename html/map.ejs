<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PokeMaps Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0f172a" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Colors */
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --bg: #ffffff;
      --surface: #f8fafc;
      --panel-bg: rgba(15, 23, 42, 0.95); /* Darker default for contrast */
      --border: #334155;
      --text-main: #f8fafc;
      --text-sub: #94a3b8;
      --danger: #ef4444;
      
      /* Dimensions */
      --sidebar-width: 320px;
      --radius: 12px;
      --shadow: 0 8px 16px -4px rgb(0 0 0 / 0.2);
      --glass: blur(16px);
    }

    /* Light Mode Overrides */
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #e2e8f0;
        --surface: #ffffff;
        --panel-bg: rgba(255, 255, 255, 0.9);
        --border: #e2e8f0;
        --text-main: #0f172a;
        --text-sub: #64748b;
      }
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text-main); }
    button { font-family: inherit; }

    /* --- ICONS --- */
    svg.icon { width: 18px; height: 18px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

    /* --- MAP --- */
    .app-shell { position: relative; width: 100%; height: 100%; }
    #map-container { position: absolute; inset: 0; z-index: 0; background: #e5e5e5; }
    iframe#map { width: 100%; height: 100%; border: 0; display: block; }

    .brand {
      position: absolute; bottom: 24px; left: 16px;
      padding: 6px 12px; font-size: 13px; font-weight: 700; letter-spacing: 0.5px;
      background: var(--panel-bg); backdrop-filter: var(--glass);
      border-radius: 8px; border: 1px solid var(--border);
      pointer-events: none; z-index: 5;
      color: var(--text-main); box-shadow: var(--shadow);
    }

    /* Marker */
    .marker-overlay { position: absolute; inset: 0; pointer-events: none; z-index: 10; display: flex; align-items: center; justify-content: center; }
    .center-marker {
      width: 20px; height: 20px; border-radius: 50%;
      background: var(--danger);
      box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.25);
      transition: all 0.2s ease;
    }

    /* --- UI LAYER --- */
    .ui-layer { position: absolute; inset: 0; z-index: 20; pointer-events: none; }
    .ui-layer > * { pointer-events: auto; }

    /* Shared Components */
    .btn {
      display: flex; align-items: center; justify-content: center; gap: 6px;
      border: 1px solid var(--border); background: var(--surface); color: var(--text-main);
      border-radius: 8px; padding: 10px 14px; font-size: 13px; font-weight: 600;
      cursor: pointer; transition: all 0.15s;
    }
    .btn:hover { background: var(--border); transform: translateY(-1px); }
    .btn.primary { background: var(--accent); color: white; border-color: transparent; }
    .btn.primary:hover { background: var(--accent-hover); }
    .btn-icon { width: 44px; height: 44px; padding: 0; border-radius: 12px; box-shadow: var(--shadow); background: var(--panel-bg); }

    .input-group { position: relative; width: 100%; }
    .search-input {
      width: 100%; height: 48px; padding: 0 16px 0 44px;
      border-radius: 12px; border: 1px solid var(--border);
      background: var(--panel-bg); backdrop-filter: var(--glass);
      color: var(--text-main); font-size: 15px; outline: none;
      box-shadow: var(--shadow); transition: border-color 0.2s;
    }
    .search-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
    .search-icon { position: absolute; left: 14px; top: 15px; color: var(--text-sub); pointer-events: none; }

    /* Suggestions */
    .suggestions {
      position: absolute; top: calc(100% + 8px); left: 0; right: 0;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; margin: 0; padding: 0; list-style: none;
      box-shadow: var(--shadow); max-height: 280px; overflow-y: auto; display: none;
    }
    .suggestions li { padding: 12px 16px; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 14px; display: block; color: var(--text-main); }
    .suggestions li:last-child { border-bottom: 0; }
    .suggestions li:hover { background: rgba(127,127,127,0.1); }

    /* --- DESKTOP SIDEBAR --- */
    @media (min-width: 769px) {
      .mobile-only { display: none !important; }
      .desktop-sidebar {
        position: absolute; top: 20px; left: 20px;
        width: var(--sidebar-width);
        max-height: calc(100vh - 40px);
        display: flex; flex-direction: column; gap: 12px;
        transition: opacity 0.2s;
      }
      
      /* HIDE other cards when searching */
      .desktop-sidebar.searching .card:not(.static) { display: none; }

      .card {
        background: var(--panel-bg); backdrop-filter: var(--glass);
        border: 1px solid var(--border); border-radius: 12px;
        box-shadow: var(--shadow); overflow: hidden;
        display: flex; flex-direction: column;
        transition: transform 0.2s;
      }

      .card-header {
        padding: 12px 16px; font-size: 13px; font-weight: 700;
        display: flex; justify-content: space-between; align-items: center;
        background: rgba(127,127,127,0.05); border-bottom: 1px solid var(--border);
        cursor: pointer; user-select: none;
      }
      .card-header:hover { background: rgba(127,127,127,0.1); }
      .card-body { padding: 16px; display: none; flex-direction: column; gap: 12px; }
      .card.open .card-body { display: flex; }
      
      /* Static card (search) has no header */
      .card.static .card-header { display: none; }
      .card.static .card-body { display: flex; padding: 12px; }

      .row { display: flex; gap: 10px; align-items: center; }
      
      /* Desktop Tools (Moved to Bottom Right to avoid Zoom Buttons) */
      .desktop-tools { 
        position: absolute; bottom: 30px; right: 20px; 
        display: flex; flex-direction: column; gap: 12px; 
      }
      
      .link-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
      .link-pill {
        font-size: 11px; text-decoration: none; color: var(--text-sub);
        border: 1px solid var(--border); padding: 4px 10px; border-radius: 99px;
        transition: all 0.2s; background: rgba(0,0,0,0.2);
      }
      .link-pill:hover { color: var(--accent); border-color: var(--accent); background: var(--surface); }
    }

    /* --- MOBILE --- */
    @media (max-width: 768px) {
      .desktop-only { display: none !important; }
      .brand { bottom: 84px; font-size: 12px; }

      .mobile-header { position: absolute; top: 12px; left: 12px; right: 12px; z-index: 30; }
      
      .mobile-dock {
        position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%);
        display: flex; gap: 20px; align-items: center;
        background: var(--panel-bg); backdrop-filter: var(--glass);
        padding: 10px 24px; border-radius: 32px; border: 1px solid var(--border);
        box-shadow: var(--shadow); z-index: 30;
      }

      .bottom-sheet {
        position: fixed; left: 0; right: 0; bottom: 0;
        background: var(--surface);
        border-radius: 24px 24px 0 0;
        box-shadow: 0 -8px 32px rgba(0,0,0,0.3);
        z-index: 40; transform: translateY(110%);
        transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
        max-height: 85vh; display: flex; flex-direction: column; border-top: 1px solid var(--border);
      }
      .bottom-sheet.open { transform: translateY(0); }
      .sheet-handle { width: 48px; height: 6px; background: var(--border); border-radius: 10px; margin: 12px auto; opacity: 0.5; }
      .sheet-content { padding: 0 20px 30px; overflow-y: auto; }
      
      .link-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); }
    }

    /* Common Utility */
    .pin-item {
      padding: 12px; background: rgba(127,127,127,0.05); border: 1px solid var(--border); border-radius: 10px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .pin-info strong { display: block; font-size: 14px; margin-bottom: 3px; }
    .pin-info span { font-size: 11px; color: var(--text-sub); font-family: monospace; }
    .pin-actions { display: flex; gap: 12px; }
    .pin-btn { background: none; border: none; cursor: pointer; padding: 4px; color: var(--text-sub); transition: color 0.2s; }
    .pin-btn:hover { color: var(--accent); }

    select.std-select {
      width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border);
      background: var(--surface); color: var(--text-main); font-size: 14px;
      appearance: none;
    }
    label { font-size: 13px; font-weight: 500; color: var(--text-sub); margin-bottom: 4px; display: block; }
  </style>
</head>
<body>

<div style="display:none">
  <svg id="icons">
    <symbol id="icon-search" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></symbol>
    <symbol id="icon-nav" viewBox="0 0 24 24"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></symbol>
    <symbol id="icon-menu" viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></symbol>
    <symbol id="icon-pin" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></symbol>
    <symbol id="icon-trash" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></symbol>
    <symbol id="icon-go" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 16 16 12 12 8"></polyline><line x1="8" y1="12" x2="16" y2="12"></line></symbol>
    <symbol id="icon-share" viewBox="0 0 24 24"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></symbol>
  </svg>
</div>

<div class="app-shell">
  
  <div id="map-container">
    <iframe id="map" title="Map"></iframe>
    <div class="marker-overlay">
      <div id="center-marker" class="center-marker"></div>
    </div>
    <div class="brand">PokeMaps Public Beta</div>
  </div>

  <div class="ui-layer">

    <div class="desktop-only desktop-sidebar">
      
      <div class="card static">
        <div class="card-body">
          <div class="input-group">
            <svg class="icon search-icon"><use href="#icon-search"/></svg>
            <input type="text" id="d-search" class="search-input" placeholder="Search places..." autocomplete="off">
            <ul id="d-suggestions" class="suggestions"></ul>
          </div>
          <div class="row">
            <button class="btn" style="flex:1" id="d-locate"><svg class="icon"><use href="#icon-nav"/></svg> Locate</button>
            <button class="btn" style="flex:1" id="d-save-pin"><svg class="icon"><use href="#icon-pin"/></svg> Save Pin</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header" onclick="this.parentElement.classList.toggle('open')">
          <span>Saved Pins</span>
          <small>‚ñº</small>
        </div>
        <div class="card-body">
          <div id="d-pin-list" style="display:flex; flex-direction:column; gap:8px;"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header" onclick="this.parentElement.classList.toggle('open')">
          <span>Settings</span>
          <small>‚ñº</small>
        </div>
        <div class="card-body">
          <div>
            <label>Map Layer</label>
            <select id="d-layer" class="std-select">
              <option value="mapnik">Standard</option>
              <option value="cyclemap">Cyclist</option>
              <option value="transportmap">Transport</option>
            </select>
          </div>
          <div class="row" style="justify-content:space-between">
            <label style="margin:0">Follow Location</label>
            <input type="checkbox" id="d-follow">
          </div>
           <div class="row" style="justify-content:space-between">
            <label style="margin:0">Dark Mode</label>
            <select id="d-theme" class="std-select" style="width:auto; padding:4px 8px">
              <option value="auto">Auto</option><option value="dark">Dark</option><option value="light">Light</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header" onclick="this.parentElement.classList.toggle('open')">
          <span>About</span>
          <small>‚ñº</small>
        </div>
        <div class="card-body" style="font-size:12px; line-height:1.5; color:var(--text-sub)">
          <p><strong>PokeMaps Public Beta</strong> is a lightweight viewer for exploring and sharing map positions.</p>
          <p><strong>Map credits:</strong> ¬© <a href="https://www.openstreetmap.org/" target="_blank" style="color:var(--accent)">OpenStreetMap.org</a> contributors.</p>
          <p><strong>Disclaimer:</strong> Geographic names and borders are for reference only.</p>
          
          <div class="link-row">
            <a class="link-pill" href="https://wiki.osmfoundation.org/wiki/Terms_of_Use" target="_blank">OSM Terms</a>
            <a class="link-pill" href="https://www.openstreetmap.org/copyright" target="_blank">Copyright</a>
            <a class="link-pill" href="https://operations.osmfoundation.org/policies/nominatim/" target="_blank">Nominatim Policy</a>
            <a class="link-pill" href="/privacy" target="_blank">Privacy Policy</a>
          </div>
        </div>
      </div>

    </div>

    <div class="desktop-only desktop-tools">
      <button class="btn btn-icon" id="d-share" title="Share Link"><svg class="icon"><use href="#icon-share"/></svg></button>
      <button class="btn btn-icon" onclick="window.open('https://www.openstreetmap.org','_blank')" title="Open OSM"><strong style="font-size:10px">OSM</strong></button>
    </div>


    <div class="mobile-only mobile-header">
      <div class="input-group">
        <svg class="icon search-icon"><use href="#icon-search"/></svg>
        <input type="text" id="m-search" class="search-input" placeholder="Search places..." autocomplete="off">
        <ul id="m-suggestions" class="suggestions"></ul>
      </div>
    </div>

    <div class="mobile-only mobile-dock">
      <button class="btn btn-icon" id="m-btn-pins"><svg class="icon"><use href="#icon-pin"/></svg></button>
      <button class="btn btn-icon primary" id="m-btn-locate" style="width:60px; height:60px"><svg class="icon"><use href="#icon-nav"/></svg></button>
      <button class="btn btn-icon" id="m-btn-menu"><svg class="icon"><use href="#icon-menu"/></svg></button>
    </div>

    <div class="mobile-only bottom-sheet" id="sheet-pins">
      <div class="sheet-handle"></div>
      <div class="sheet-content">
        <div class="row" style="justify-content:space-between; margin-bottom:16px">
          <strong style="font-size:18px">Saved Pins</strong>
          <button class="btn primary" id="m-save-curr" style="font-size:12px">+ Save Current</button>
        </div>
        <div id="m-pin-list" style="display:flex; flex-direction:column; gap:10px; padding-bottom:60px"></div>
      </div>
    </div>

    <div class="mobile-only bottom-sheet" id="sheet-menu">
      <div class="sheet-handle"></div>
      <div class="sheet-content">
        <div style="margin-bottom:24px">
          <label style="display:block; margin-bottom:8px; font-weight:600">Map Layer</label>
          <select id="m-layer" class="std-select">
            <option value="mapnik">Standard</option>
            <option value="cyclemap">Cyclist</option>
            <option value="transportmap">Transport</option>
          </select>
        </div>
        
        <div class="row" style="justify-content:space-between; padding:12px 0; border-top:1px solid var(--border)">
          <span>Follow Location</span>
          <input type="checkbox" id="m-follow">
        </div>
        <div class="row" style="justify-content:space-between; padding:12px 0; border-top:1px solid var(--border)">
          <span>Theme</span>
          <select id="m-theme" class="std-select" style="width:auto">
            <option value="auto">Auto</option><option value="dark">Dark</option><option value="light">Light</option>
          </select>
        </div>

        <div style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border)">
          <strong style="display:block; margin-bottom:10px">About PokeMaps</strong>
          <p style="font-size:13px; color:var(--text-sub); line-height:1.5">
            A lightweight map viewer. Search provided by Nominatim/OSM. Tiles by OpenStreetMap.
          </p>
          <div class="link-row">
            <a class="link-pill" href="https://wiki.osmfoundation.org/wiki/Terms_of_Use">OSM Terms</a>
            <a class="link-pill" href="https://www.openstreetmap.org/copyright">Copyright</a>
            <a class="link-pill" href="/privacy">Privacy Policy</a>
          </div>
        </div>
        <div style="height:60px"></div>
      </div>
    </div>

  </div>
</div>

<script>
;(() => {
  // State
  const STATE = { lat: 30.41, lon: 72.44, delta: 0.25, layer: 'mapnik', following: false };
  let PINS = [];
  try { PINS = JSON.parse(localStorage.getItem('pm_pins') || '[]'); } catch(e){}
  
  const EL = (sel) => document.querySelector(sel);
  
  // UI References
  const ui = {
    map: EL('#map'),
    marker: EL('#center-marker'),
    d_search: EL('#d-search'), d_sug: EL('#d-suggestions'),
    m_search: EL('#m-search'), m_sug: EL('#m-suggestions'),
    // Desktop
    sidebar: EL('.desktop-sidebar'),
    d_locate: EL('#d-locate'), d_save: EL('#d-save-pin'), d_pinList: EL('#d-pin-list'),
    d_layer: EL('#d-layer'), d_follow: EL('#d-follow'), d_theme: EL('#d-theme'), d_share: EL('#d-share'),
    // Mobile
    m_locate: EL('#m-btn-locate'), m_pinsBtn: EL('#m-btn-pins'), m_menuBtn: EL('#m-btn-menu'),
    m_save: EL('#m-save-curr'), m_pinList: EL('#m-pin-list'),
    m_layer: EL('#m-layer'), m_follow: EL('#m-follow'), m_theme: EL('#m-theme'),
    sheetPins: EL('#sheet-pins'), sheetMenu: EL('#sheet-menu')
  };

  // --- MAP CORE ---
  const updateMap = (push = false) => {
    STATE.delta = Math.max(0.0005, Math.min(45, STATE.delta));
    const bbox = {
      l: (STATE.lon - STATE.delta).toFixed(6),
      b: (STATE.lat - STATE.delta).toFixed(6),
      r: (STATE.lon + STATE.delta).toFixed(6),
      t: (STATE.lat + STATE.delta).toFixed(6)
    };
    const src = `https://www.openstreetmap.org/export/embed.html?bbox=${bbox.l}%2C${bbox.b}%2C${bbox.r}%2C${bbox.t}&layer=${STATE.layer}`;
    if (ui.map.src !== src) ui.map.src = src;

    if (push) {
      const u = new URL(location);
      u.searchParams.set('lat', STATE.lat.toFixed(5));
      u.searchParams.set('lon', STATE.lon.toFixed(5));
      u.searchParams.set('d', STATE.delta.toFixed(4));
      u.searchParams.set('l', STATE.layer);
      history.pushState(STATE, '', u);
    }
    
    // Sync Inputs
    if(ui.d_layer.value !== STATE.layer) ui.d_layer.value = STATE.layer;
    if(ui.m_layer.value !== STATE.layer) ui.m_layer.value = STATE.layer;
    ui.marker.style.background = STATE.following ? 'var(--accent)' : 'var(--danger)';
    ui.marker.style.boxShadow = STATE.following ? '0 0 0 4px var(--accent-hover)' : '0 0 0 4px rgba(239, 68, 68, 0.25)';
  };

  // --- LOCATION ---
  let watchId = null;
  const toggleFollow = () => {
    if (STATE.following) {
      STATE.following = false;
      if (watchId) navigator.geolocation.clearWatch(watchId);
      ui.d_follow.checked = false; ui.m_follow.checked = false;
      updateMap();
    } else {
      if (!navigator.geolocation) return alert("Geolocation not supported");
      STATE.following = true;
      ui.d_follow.checked = true; ui.m_follow.checked = true;
      watchId = navigator.geolocation.watchPosition(
        p => { STATE.lat = p.coords.latitude; STATE.lon = p.coords.longitude; updateMap(); },
        e => { alert("Location access denied"); toggleFollow(); },
        { enableHighAccuracy: true }
      );
    }
  };
  const locateOnce = () => {
    navigator.geolocation.getCurrentPosition(p => {
      STATE.lat = p.coords.latitude; STATE.lon = p.coords.longitude; STATE.delta = 0.01;
      updateMap(true);
    }, e => alert("Could not locate"));
  };

  // --- SEARCH ---
  let timer;
  const doSearch = (val, list) => {
    if (!val || val.length < 3) { list.style.display = 'none'; return; }
    
    // Coords check
    const m = val.match(/([+-]?\d+\.?\d*)\s*,\s*([+-]?\d+\.?\d*)/);
    if(m) {
      const lat = parseFloat(m[1]), lon = parseFloat(m[2]);
      list.innerHTML = `<li onclick="goTo(${lat},${lon})">üìç ${lat.toFixed(4)}, ${lon.toFixed(4)}</li>`;
      list.style.display = 'block';
      return;
    }

    clearTimeout(timer);
    timer = setTimeout(async () => {
      try {
        const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}`);
        const d = await r.json();
        list.innerHTML = '';
        if(!d.length) { list.style.display = 'none'; return; }
        d.slice(0,5).forEach(i => {
          const li = document.createElement('li');
          li.textContent = i.display_name;
          li.onclick = () => { 
            goTo(parseFloat(i.lat), parseFloat(i.lon)); 
            list.style.display = 'none'; 
            ui.d_search.value = i.display_name.split(',')[0];
            ui.m_search.value = ui.d_search.value;
          };
          list.appendChild(li);
        });
        list.style.display = 'block';
      } catch(e){}
    }, 400);
  };
  
  window.goTo = (lat, lon) => { STATE.lat = lat; STATE.lon = lon; updateMap(true); };

  // --- PINS ---
  const renderPins = () => {
    const html = PINS.length ? PINS.map((p, i) => `
      <div class="pin-item">
        <div class="pin-info"><strong>${p.name}</strong><span>${p.lat.toFixed(4)}, ${p.lon.toFixed(4)}</span></div>
        <div class="pin-actions">
          <button class="pin-btn" onclick="loadPin(${i})"><svg class="icon"><use href="#icon-go"/></svg></button>
          <button class="pin-btn" onclick="delPin(${i})"><svg class="icon"><use href="#icon-trash"/></svg></button>
        </div>
      </div>
    `).join('') : '<div style="text-align:center; opacity:0.6; padding:10px; font-size:12px">No pins yet</div>';
    
    ui.d_pinList.innerHTML = html;
    ui.m_pinList.innerHTML = html;
  };

  window.loadPin = (i) => { STATE.lat = PINS[i].lat; STATE.lon = PINS[i].lon; STATE.layer = PINS[i].layer; updateMap(true); closeSheets(); };
  window.delPin = (i) => { if(confirm("Delete pin?")){ PINS.splice(i,1); localStorage.setItem('pm_pins', JSON.stringify(PINS)); renderPins(); } };
  
  const savePin = () => {
    const name = prompt("Name this location:", "New Pin");
    if(name) {
      PINS.unshift({ name, lat: STATE.lat, lon: STATE.lon, layer: STATE.layer });
      localStorage.setItem('pm_pins', JSON.stringify(PINS));
      renderPins();
    }
  };

  // --- MISC ---
  const closeSheets = () => document.querySelectorAll('.bottom-sheet').forEach(s => s.classList.remove('open'));
  const toggleSheet = (s) => { const o = s.classList.contains('open'); closeSheets(); if(!o) s.classList.add('open'); };
  
  const applyTheme = (t) => {
    document.documentElement.style.colorScheme = t === 'auto' ? 'dark light' : t;
    ui.d_theme.value = t; ui.m_theme.value = t;
  };

  // --- LISTENERS ---
  ui.d_search.oninput = (e) => doSearch(e.target.value, ui.d_sug);
  ui.m_search.oninput = (e) => doSearch(e.target.value, ui.m_sug);
  
  // Auto-hide Sidebar on focus
  ui.d_search.onfocus = () => ui.sidebar.classList.add('searching');
  ui.d_search.onblur = () => setTimeout(() => ui.sidebar.classList.remove('searching'), 200);

  ui.d_locate.onclick = locateOnce;
  ui.m_locate.onclick = locateOnce;
  ui.d_save.onclick = savePin;
  ui.m_save.onclick = savePin;
  ui.d_share.onclick = () => { navigator.clipboard.writeText(location.href); alert("Copied to clipboard!"); };
  
  ui.d_layer.onchange = (e) => { STATE.layer = e.target.value; updateMap(true); };
  ui.m_layer.onchange = (e) => { STATE.layer = e.target.value; updateMap(true); };
  
  ui.d_follow.onchange = toggleFollow;
  ui.m_follow.onchange = toggleFollow;
  
  ui.d_theme.onchange = (e) => applyTheme(e.target.value);
  ui.m_theme.onchange = (e) => applyTheme(e.target.value);
  
  ui.m_pinsBtn.onclick = () => toggleSheet(ui.sheetPins);
  ui.m_menuBtn.onclick = () => toggleSheet(ui.sheetMenu);
  
  document.body.onclick = (e) => {
    if(!e.target.closest('.bottom-sheet') && !e.target.closest('.mobile-dock')) closeSheets();
    if(!e.target.closest('.input-group')) { ui.d_sug.style.display='none'; ui.m_sug.style.display='none'; }
  };

  // Init
  const p = new URLSearchParams(location.search);
  if(p.has('lat')) { STATE.lat = parseFloat(p.get('lat')); STATE.lon = parseFloat(p.get('lon')); }
  if(p.has('l')) STATE.layer = p.get('l');
  
  renderPins();
  updateMap();
})();
</script>
</body>
</html>