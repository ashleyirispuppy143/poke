<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PokeMaps Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0f172a" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Colors */
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --bg: #ffffff;
      --surface: #f8fafc;
      --panel-bg: rgba(22, 26, 35, 0.85); /* Defaulting to a dark glass for better contrast on maps */
      --border: rgba(255, 255, 255, 0.1);
      --text-main: #ffffff;
      --text-sub: #94a3b8;
      --danger: #ef4444;
      
      /* Dimensions */
      --sidebar-width: 320px;
      --radius: 16px;
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      --glass: blur(16px) saturate(180%);
      
      /* User Settings Defaults */
      --marker-size: 20px;
      --marker-color: #ef4444;
    }

    /* Light Mode Override if system prefers, but map UI often looks best dark */
    @media (prefers-color-scheme: light) {
      body.light-mode {
        --panel-bg: rgba(255, 255, 255, 0.9);
        --border: #e2e8f0;
        --text-main: #0f172a;
        --text-sub: #64748b;
        --shadow: 0 4px 12px rgba(0,0,0,0.1);
      }
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    body { font-family: 'Inter', system-ui, sans-serif; background: #000; color: var(--text-main); }
    button { font-family: inherit; }

    /* --- ICONS --- */
    svg.icon { width: 18px; height: 18px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

    /* --- MAP --- */
    .app-shell { position: relative; width: 100%; height: 100%; }
    #map-container { position: absolute; inset: 0; z-index: 0; background: #222; }
    iframe#map { width: 100%; height: 100%; border: 0; display: block; }

    /* Brand Tag */
    .brand {
      position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%);
      padding: 6px 12px; font-size: 13px; font-weight: 600;
      background: var(--panel-bg); backdrop-filter: var(--glass);
      border-radius: 20px; border: 1px solid var(--border);
      pointer-events: none; z-index: 5;
      color: var(--text-main); box-shadow: var(--shadow);
    }

    /* Marker */
    .marker-overlay { position: absolute; inset: 0; pointer-events: none; z-index: 10; display: flex; align-items: center; justify-content: center; }
    .center-marker {
      width: var(--marker-size); height: var(--marker-size); border-radius: 50%;
      background: var(--marker-color);
      box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.2);
      transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .center-marker::after {
      content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 4px; height: 4px; background: rgba(0,0,0,0.5); border-radius: 50%;
    }

    /* --- UI LAYER --- */
    .ui-layer { position: absolute; inset: 0; z-index: 20; pointer-events: none; }
    .ui-layer > * { pointer-events: auto; }

    /* Shared Components */
    .btn {
      display: flex; align-items: center; justify-content: center; gap: 6px;
      border: 1px solid var(--border); background: rgba(255,255,255,0.05); color: var(--text-main);
      border-radius: 8px; padding: 10px 14px; font-size: 13px; font-weight: 500;
      cursor: pointer; transition: all 0.2s;
    }
    .btn:hover { background: rgba(255,255,255,0.1); transform: translateY(-1px); }
    .btn.primary { background: var(--accent); color: white; border-color: transparent; }
    .btn.primary:hover { background: var(--accent-hover); }
    
    .btn-icon { width: 42px; height: 42px; padding: 0; border-radius: 12px; box-shadow: var(--shadow); background: var(--panel-bg); backdrop-filter: var(--glass); border: 1px solid var(--border); }

    .input-group { position: relative; width: 100%; transition: all 0.3s ease; }
    .search-input {
      width: 100%; height: 50px; padding: 0 16px 0 48px;
      border-radius: 14px; border: 1px solid var(--border);
      background: rgba(0,0,0,0.2); 
      color: var(--text-main); font-size: 15px; outline: none;
      transition: all 0.2s;
    }
    .search-input::placeholder { color: var(--text-sub); opacity: 0.7; }
    .search-input:focus { background: rgba(0,0,0,0.4); border-color: var(--accent); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
    .search-icon { position: absolute; left: 16px; top: 16px; color: var(--text-sub); pointer-events: none; }

    /* --- RICH AUTOCOMPLETE DROPDOWN --- */
    .suggestions {
      position: absolute; top: calc(100% + 8px); left: 0; right: 0;
      background: var(--panel-bg); backdrop-filter: var(--glass);
      border: 1px solid var(--border);
      border-radius: 14px; margin: 0; padding: 6px; list-style: none;
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
      max-height: 320px; overflow-y: auto; display: none;
      animation: slideDown 0.2s ease-out;
    }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    .suggestions li {
      padding: 10px 12px; border-radius: 8px;
      cursor: pointer; display: flex; align-items: center; gap: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.03);
      transition: background 0.15s;
    }
    .suggestions li:last-child { border-bottom: 0; }
    .suggestions li:hover { background: rgba(255,255,255,0.1); }
    
    .sug-icon {
      width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
      background: rgba(59, 130, 246, 0.15); color: var(--accent);
      border-radius: 8px; flex-shrink: 0;
    }
    .sug-text { display: flex; flex-direction: column; overflow: hidden; }
    .sug-title { font-weight: 600; font-size: 14px; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sug-sub { font-size: 12px; color: var(--text-sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }

    /* --- DESKTOP SIDEBAR --- */
    @media (min-width: 769px) {
      .mobile-only { display: none !important; }
      
      .desktop-sidebar {
        position: absolute; top: 20px; left: 20px;
        width: var(--sidebar-width);
        max-height: calc(100vh - 40px);
        display: flex; flex-direction: column; gap: 12px;
        transition: opacity 0.3s ease;
      }
      
      /* Hide non-search items when searching */
      .desktop-sidebar.searching .card:not(.search-card) {
        display: none;
      }

      .card {
        background: var(--panel-bg); backdrop-filter: var(--glass);
        border: 1px solid var(--border); border-radius: 16px;
        box-shadow: var(--shadow); overflow: hidden;
        display: flex; flex-direction: column;
        transition: transform 0.2s;
      }

      .card-header {
        padding: 14px 16px; font-size: 13px; font-weight: 600;
        display: flex; justify-content: space-between; align-items: center;
        background: rgba(255,255,255,0.02); border-bottom: 1px solid var(--border);
        cursor: pointer; user-select: none; color: var(--text-sub);
      }
      .card-header:hover { color: var(--text-main); background: rgba(255,255,255,0.05); }
      .card-body { padding: 16px; display: none; flex-direction: column; gap: 14px; }
      .card.open .card-body { display: flex; animation: fadeIn 0.3s; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

      /* Static card (Search) */
      .card.static .card-header { display: none; }
      .card.static .card-body { display: flex; padding: 12px; gap: 12px; }

      .row { display: flex; gap: 10px; align-items: center; }
      .row.between { justify-content: space-between; }
      
      /* Desktop Tools (Top Right) */
      .desktop-tools { position: absolute; top: 20px; right: 20px; display: flex; flex-direction: column; gap: 12px; }
      
      .link-row { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
      .link-pill {
        font-size: 10px; text-decoration: none; color: var(--text-sub);
        border: 1px solid var(--border); padding: 4px 10px; border-radius: 12px;
        transition: all 0.2s;
      }
      .link-pill:hover { color: var(--accent); border-color: var(--accent); background: rgba(59, 130, 246, 0.1); }
    }

    /* --- MOBILE --- */
    @media (max-width: 768px) {
      .desktop-only { display: none !important; }
      .brand { bottom: 90px; font-size: 11px; opacity: 0.8; }

      .mobile-header { position: absolute; top: 12px; left: 12px; right: 12px; z-index: 30; }
      
      .mobile-dock {
        position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
        display: flex; gap: 20px; align-items: center;
        background: var(--panel-bg); backdrop-filter: var(--glass);
        padding: 10px 24px; border-radius: 30px; border: 1px solid var(--border);
        box-shadow: var(--shadow); z-index: 30;
      }
      .mobile-dock .btn-icon { width: 48px; height: 48px; border-radius: 20px; background: transparent; border: 0; box-shadow: none; }
      .mobile-dock .btn-icon:active { transform: scale(0.9); background: rgba(255,255,255,0.1); }

      .bottom-sheet {
        position: fixed; left: 0; right: 0; bottom: 0;
        background: #111; /* Opaque for mobile perf */
        border-top: 1px solid var(--border);
        border-radius: 24px 24px 0 0;
        box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        z-index: 40; transform: translateY(110%);
        transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
        max-height: 85vh; display: flex; flex-direction: column;
      }
      .bottom-sheet.open { transform: translateY(0); }
      .sheet-handle { width: 40px; height: 4px; background: var(--border); border-radius: 10px; margin: 12px auto; opacity: 0.5; }
      .sheet-content { padding: 10px 20px 40px; overflow-y: auto; }
      
      .link-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); }
    }

    /* Common Utility */
    .pin-item {
      padding: 12px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 10px;
      display: flex; justify-content: space-between; align-items: center; transition: background 0.2s;
    }
    .pin-item:hover { background: rgba(255,255,255,0.06); }
    .pin-info strong { display: block; font-size: 13px; margin-bottom: 4px; color: var(--text-main); }
    .pin-info span { font-size: 11px; color: var(--text-sub); font-family: monospace; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; }
    .pin-actions { display: flex; gap: 8px; }
    .pin-btn { background: none; border: none; cursor: pointer; padding: 6px; color: var(--text-sub); border-radius: 6px; }
    .pin-btn:hover { color: var(--accent); background: rgba(255,255,255,0.05); }

    select.std-select {
      width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border);
      background: rgba(0,0,0,0.3); color: var(--text-main); outline: none;
      cursor: pointer;
    }
    input[type="color"] { width: 40px; height: 30px; border: 0; background: none; cursor: pointer; }
    input[type="range"] { accent-color: var(--accent); width: 100px; }
    label { font-size: 13px; font-weight: 500; color: var(--text-sub); }
  </style>
</head>
<body class="">

<div style="display:none">
  <svg id="icons">
    <symbol id="icon-search" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></symbol>
    <symbol id="icon-nav" viewBox="0 0 24 24"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></symbol>
    <symbol id="icon-menu" viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></symbol>
    <symbol id="icon-pin" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></symbol>
    <symbol id="icon-trash" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></symbol>
    <symbol id="icon-go" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 16 16 12 12 8"></polyline><line x1="8" y1="12" x2="16" y2="12"></line></symbol>
    <symbol id="icon-share" viewBox="0 0 24 24"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></symbol>
    <symbol id="icon-loc" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7z"></path><circle cx="12" cy="9" r="2.5"></circle></symbol>
  </svg>
</div>

<div class="app-shell">
  
  <div id="map-container">
    <iframe id="map" title="Map"></iframe>
    <div class="marker-overlay">
      <div id="center-marker" class="center-marker"></div>
    </div>
    <div class="brand">PokeMaps Public Beta</div>
  </div>

  <div class="ui-layer">

    <div class="desktop-only desktop-sidebar" id="sidebar">
      
      <div class="card search-card static">
        <div class="card-body">
          <div class="input-group">
            <svg class="icon search-icon"><use href="#icon-search"/></svg>
            <input type="text" id="d-search" class="search-input" placeholder="Search places..." autocomplete="off">
            <ul id="d-suggestions" class="suggestions"></ul>
          </div>
          <div class="row">
            <button class="btn" style="flex:1" id="d-locate"><svg class="icon"><use href="#icon-nav"/></svg> Locate</button>
            <button class="btn" style="flex:1" id="d-save-pin"><svg class="icon"><use href="#icon-pin"/></svg> Save</button>
          </div>
        </div>
      </div>

      <div class="card open">
        <div class="card-header" onclick="this.parentElement.classList.toggle('open')">
          <span>Saved Pins</span>
          <svg class="icon" style="opacity:0.5; width:14px; height:14px"><use href="#icon-pin"/></svg>
        </div>
        <div class="card-body">
          <div id="d-pin-list" style="display:flex; flex-direction:column; gap:8px;"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header" onclick="this.parentElement.classList.toggle('open')">
          <span>Settings</span>
          <svg class="icon" style="opacity:0.5; width:14px; height:14px"><use href="#icon-menu"/></svg>
        </div>
        <div class="card-body">
          <label>Layer</label>
          <select id="d-layer" class="std-select">
            <option value="mapnik">Standard</option>
            <option value="cyclemap">Cyclist</option>
            <option value="transportmap">Transport</option>
            <option value="hot">Humanitarian</option>
          </select>
          
          <div class="row between" style="margin-top:4px">
            <label>Auto-Follow</label>
            <input type="checkbox" id="d-follow" style="width:16px; height:16px; accent-color:var(--accent)">
          </div>
          
          <div class="row between">
             <label>Theme</label>
             <select id="d-theme" class="std-select" style="width:auto; padding:4px 8px; font-size:12px">
               <option value="auto">Auto</option><option value="dark">Dark</option><option value="light">Light</option>
             </select>
          </div>

          <hr style="border:0; border-top:1px solid var(--border); width:100%; margin:4px 0;">
          
          <div class="row between">
            <label>Marker Size</label>
            <input type="range" id="d-marker-size" min="10" max="50" value="20">
          </div>
          <div class="row between">
            <label>Marker Color</label>
            <input type="color" id="d-marker-color" value="#ef4444">
          </div>

        </div>
      </div>

      <div class="card">
        <div class="card-header" onclick="this.parentElement.classList.toggle('open')">
          <span>About</span>
          <small style="opacity:0.5">ℹ</small>
        </div>
        <div class="card-body" style="font-size:12px; line-height:1.6; color:var(--text-sub)">
          <p><strong>PokeMaps Public Beta</strong><br>Lightweight, fast, and privacy-focused map viewer.</p>
          <p>Data © <a href="https://www.openstreetmap.org/" target="_blank" style="color:var(--accent)">OpenStreetMap</a>.</p>
          
          <div class="link-row">
            <a class="link-pill" href="https://wiki.osmfoundation.org/wiki/Terms_of_Use" target="_blank">OSM Terms</a>
            <a class="link-pill" href="https://www.openstreetmap.org/copyright" target="_blank">Copyright</a>
            <a class="link-pill" href="https://operations.osmfoundation.org/policies/nominatim/" target="_blank">Data Policy</a>
            <a class="link-pill" href="/privacy" target="_blank">Privacy</a>
          </div>
        </div>
      </div>

    </div>

    <div class="desktop-only desktop-tools">
      <button class="btn btn-icon" id="d-share" title="Share Link"><svg class="icon"><use href="#icon-share"/></svg></button>
      <button class="btn btn-icon" onclick="window.open('https://www.openstreetmap.org','_blank')" title="Open in OSM"><strong style="font-size:10px; color:var(--accent)">OSM</strong></button>
    </div>


    <div class="mobile-only mobile-header">
      <div class="input-group">
        <svg class="icon search-icon"><use href="#icon-search"/></svg>
        <input type="text" id="m-search" class="search-input" placeholder="Search places..." autocomplete="off">
        <ul id="m-suggestions" class="suggestions"></ul>
      </div>
    </div>

    <div class="mobile-only mobile-dock">
      <button class="btn-icon" id="m-btn-pins"><svg class="icon"><use href="#icon-pin"/></svg></button>
      <button class="btn-icon primary" id="m-btn-locate" style="width:64px; height:64px; border-radius:24px; background:var(--accent); color:#fff"><svg class="icon" style="width:24px; height:24px"><use href="#icon-nav"/></svg></button>
      <button class="btn-icon" id="m-btn-menu"><svg class="icon"><use href="#icon-menu"/></svg></button>
    </div>

    <div class="mobile-only bottom-sheet" id="sheet-pins">
      <div class="sheet-handle"></div>
      <div class="sheet-content">
        <div class="row" style="justify-content:space-between; margin-bottom:16px; align-items:center;">
          <strong style="font-size:18px">Saved Pins</strong>
          <button class="btn primary" id="m-save-curr" style="font-size:12px; padding:6px 12px">+ Save Current</button>
        </div>
        <div id="m-pin-list" style="display:flex; flex-direction:column; gap:10px; padding-bottom:60px"></div>
      </div>
    </div>

    <div class="mobile-only bottom-sheet" id="sheet-menu">
      <div class="sheet-handle"></div>
      <div class="sheet-content">
        <strong style="font-size:18px; display:block; margin-bottom:20px">Map Settings</strong>
        
        <div style="margin-bottom:20px">
          <label style="display:block; margin-bottom:8px">Map Layer</label>
          <select id="m-layer" class="std-select">
            <option value="mapnik">Standard</option>
            <option value="cyclemap">Cyclist</option>
            <option value="transportmap">Transport</option>
            <option value="hot">Humanitarian</option>
          </select>
        </div>
        
        <div class="row between" style="padding:14px 0; border-top:1px solid var(--border)">
          <span>Follow Location</span>
          <input type="checkbox" id="m-follow" style="width:20px; height:20px; accent-color:var(--accent)">
        </div>
        <div class="row between" style="padding:14px 0; border-top:1px solid var(--border)">
          <span>Theme</span>
          <select id="m-theme" class="std-select" style="width:auto">
            <option value="auto">Auto</option><option value="dark">Dark</option><option value="light">Light</option>
          </select>
        </div>

        <div style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border)">
          <div class="link-row">
            <a class="link-pill" href="https://wiki.osmfoundation.org/wiki/Terms_of_Use">OSM Terms</a>
            <a class="link-pill" href="/privacy">Privacy Policy</a>
          </div>
        </div>
        <div style="height:60px"></div>
      </div>
    </div>

  </div>
</div>

<script>
;(() => {
  // State
  const STATE = { lat: 30.41, lon: 72.44, delta: 0.25, layer: 'mapnik', following: false };
  let PINS = [];
  try { PINS = JSON.parse(localStorage.getItem('pm_pins') || '[]'); } catch(e){}
  
  const EL = (sel) => document.querySelector(sel);
  
  // UI References
  const ui = {
    map: EL('#map'),
    marker: EL('#center-marker'),
    sidebar: EL('#sidebar'),
    d_search: EL('#d-search'), d_sug: EL('#d-suggestions'),
    m_search: EL('#m-search'), m_sug: EL('#m-suggestions'),
    // Desktop Inputs
    d_locate: EL('#d-locate'), d_save: EL('#d-save-pin'), d_pinList: EL('#d-pin-list'),
    d_layer: EL('#d-layer'), d_follow: EL('#d-follow'), d_theme: EL('#d-theme'), d_share: EL('#d-share'),
    d_mSize: EL('#d-marker-size'), d_mColor: EL('#d-marker-color'),
    // Mobile Inputs
    m_locate: EL('#m-btn-locate'), m_pinsBtn: EL('#m-btn-pins'), m_menuBtn: EL('#m-btn-menu'),
    m_save: EL('#m-save-curr'), m_pinList: EL('#m-pin-list'),
    m_layer: EL('#m-layer'), m_follow: EL('#m-follow'), m_theme: EL('#m-theme'),
    sheetPins: EL('#sheet-pins'), sheetMenu: EL('#sheet-menu')
  };

  // --- MAP CORE ---
  const updateMap = (push = false) => {
    STATE.delta = Math.max(0.0005, Math.min(45, STATE.delta));
    const bbox = {
      l: (STATE.lon - STATE.delta).toFixed(6),
      b: (STATE.lat - STATE.delta).toFixed(6),
      r: (STATE.lon + STATE.delta).toFixed(6),
      t: (STATE.lat + STATE.delta).toFixed(6)
    };
    const src = `https://www.openstreetmap.org/export/embed.html?bbox=${bbox.l}%2C${bbox.b}%2C${bbox.r}%2C${bbox.t}&layer=${STATE.layer}`;
    if (ui.map.src !== src) ui.map.src = src;

    if (push) {
      const u = new URL(location);
      u.searchParams.set('lat', STATE.lat.toFixed(5));
      u.searchParams.set('lon', STATE.lon.toFixed(5));
      u.searchParams.set('d', STATE.delta.toFixed(4));
      u.searchParams.set('l', STATE.layer);
      history.pushState(STATE, '', u);
    }
    
    // Sync Inputs
    if(ui.d_layer.value !== STATE.layer) ui.d_layer.value = STATE.layer;
    if(ui.m_layer.value !== STATE.layer) ui.m_layer.value = STATE.layer;
    
    // Follow State
    ui.d_follow.checked = STATE.following;
    ui.m_follow.checked = STATE.following;
  };

  // --- FOCUS MODE (Sidebar invisible while searching) ---
  const setFocusMode = (isFocused) => {
    if(window.innerWidth > 768) {
      if(isFocused) ui.sidebar.classList.add('searching');
      else ui.sidebar.classList.remove('searching');
    }
  };
  ui.d_search.addEventListener('focus', () => setFocusMode(true));
  // Delay blur to allow clicking suggestions
  ui.d_search.addEventListener('blur', () => setTimeout(() => setFocusMode(false), 200));

  // --- SEARCH ---
  let timer;
  const doSearch = (val, list) => {
    if (!val || val.length < 3) { list.style.display = 'none'; return; }
    
    // Coords check
    const m = val.match(/([+-]?\d+\.?\d*)\s*,\s*([+-]?\d+\.?\d*)/);
    if(m) {
      const lat = parseFloat(m[1]), lon = parseFloat(m[2]);
      list.innerHTML = `
        <li onclick="goTo(${lat},${lon})">
          <div class="sug-icon"><svg class="icon"><use href="#icon-loc"/></svg></div>
          <div class="sug-text">
            <span class="sug-title">${lat.toFixed(4)}, ${lon.toFixed(4)}</span>
            <span class="sug-sub">Coordinates</span>
          </div>
        </li>`;
      list.style.display = 'block';
      return;
    }

    clearTimeout(timer);
    timer = setTimeout(async () => {
      try {
        const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}`);
        const d = await r.json();
        list.innerHTML = '';
        if(!d.length) { list.style.display = 'none'; return; }
        
        d.slice(0,5).forEach(i => {
          // Parse Name vs Address
          let parts = i.display_name.split(',');
          let main = parts[0];
          let sub = parts.slice(1).join(',').trim();

          const li = document.createElement('li');
          li.innerHTML = `
            <div class="sug-icon"><svg class="icon"><use href="#icon-loc"/></svg></div>
            <div class="sug-text">
              <span class="sug-title">${main}</span>
              <span class="sug-sub">${sub}</span>
            </div>
          `;
          li.onclick = () => { 
            goTo(parseFloat(i.lat), parseFloat(i.lon)); 
            list.style.display = 'none'; 
            ui.d_search.value = main;
            ui.m_search.value = main;
            ui.d_search.blur(); ui.m_search.blur();
          };
          list.appendChild(li);
        });
        list.style.display = 'block';
      } catch(e){}
    }, 400);
  };
  
  window.goTo = (lat, lon) => { 
    STATE.lat = lat; STATE.lon = lon; STATE.following = false; updateMap(true); 
  };

  // --- LOCATION & PINS ---
  let watchId = null;
  const toggleFollow = () => {
    if (STATE.following) {
      STATE.following = false;
      if (watchId) navigator.geolocation.clearWatch(watchId);
      updateMap();
    } else {
      if (!navigator.geolocation) return alert("Geolocation not supported");
      STATE.following = true;
      watchId = navigator.geolocation.watchPosition(
        p => { STATE.lat = p.coords.latitude; STATE.lon = p.coords.longitude; updateMap(); },
        e => { STATE.following = false; updateMap(); alert("Location access denied"); },
        { enableHighAccuracy: true }
      );
      updateMap(); // update UI immediately
    }
  };
  const locateOnce = () => {
    navigator.geolocation.getCurrentPosition(p => {
      STATE.lat = p.coords.latitude; STATE.lon = p.coords.longitude; STATE.delta = 0.01;
      updateMap(true);
    }, e => alert("Could not locate"));
  };

  const renderPins = () => {
    const html = PINS.length ? PINS.map((p, i) => `
      <div class="pin-item">
        <div class="pin-info"><strong>${p.name}</strong><span>${p.lat.toFixed(4)}, ${p.lon.toFixed(4)}</span></div>
        <div class="pin-actions">
          <button class="pin-btn" onclick="loadPin(${i})" title="Go"><svg class="icon"><use href="#icon-go"/></svg></button>
          <button class="pin-btn" onclick="delPin(${i})" title="Delete"><svg class="icon"><use href="#icon-trash"/></svg></button>
        </div>
      </div>
    `).join('') : '<div style="text-align:center; opacity:0.5; padding:20px; font-size:13px">No saved pins</div>';
    
    ui.d_pinList.innerHTML = html;
    ui.m_pinList.innerHTML = html;
  };

  window.loadPin = (i) => { STATE.lat = PINS[i].lat; STATE.lon = PINS[i].lon; STATE.layer = PINS[i].layer || 'mapnik'; updateMap(true); closeSheets(); };
  window.delPin = (i) => { if(confirm("Remove this pin?")){ PINS.splice(i,1); localStorage.setItem('pm_pins', JSON.stringify(PINS)); renderPins(); } };
  
  const savePin = () => {
    const name = prompt("Name this location:", "New Place");
    if(name) {
      PINS.unshift({ name, lat: STATE.lat, lon: STATE.lon, layer: STATE.layer });
      localStorage.setItem('pm_pins', JSON.stringify(PINS));
      renderPins();
    }
  };

  // --- MARKER & THEME SETTINGS ---
  const updateMarker = () => {
    const size = ui.d_mSize.value + 'px';
    const color = ui.d_mColor.value;
    document.documentElement.style.setProperty('--marker-size', size);
    document.documentElement.style.setProperty('--marker-color', color);
  };
  ui.d_mSize.oninput = updateMarker;
  ui.d_mColor.oninput = updateMarker;

  const applyTheme = (t) => {
    document.body.classList.toggle('light-mode', t === 'light');
    if(t === 'auto') document.body.classList.remove('light-mode'); // simplified logic
    ui.d_theme.value = t; ui.m_theme.value = t;
  };

  // --- MOBILE SHEETS ---
  const closeSheets = () => document.querySelectorAll('.bottom-sheet').forEach(s => s.classList.remove('open'));
  const toggleSheet = (s) => { const o = s.classList.contains('open'); closeSheets(); if(!o) s.classList.add('open'); };
  
  // --- LISTENERS ---
  ui.d_search.oninput = (e) => doSearch(e.target.value, ui.d_sug);
  ui.m_search.oninput = (e) => doSearch(e.target.value, ui.m_sug);
  
  ui.d_locate.onclick = locateOnce; ui.m_locate.onclick = locateOnce;
  ui.d_save.onclick = savePin; ui.m_save.onclick = savePin;
  ui.d_share.onclick = () => { navigator.clipboard.writeText(location.href); alert("Link copied!"); };
  
  ui.d_layer.onchange = (e) => { STATE.layer = e.target.value; updateMap(true); };
  ui.m_layer.onchange = (e) => { STATE.layer = e.target.value; updateMap(true); };
  
  ui.d_follow.onchange = toggleFollow; ui.m_follow.onchange = toggleFollow;
  ui.d_theme.onchange = (e) => applyTheme(e.target.value); ui.m_theme.onchange = (e) => applyTheme(e.target.value);
  
  ui.m_pinsBtn.onclick = () => toggleSheet(ui.sheetPins);
  ui.m_menuBtn.onclick = () => toggleSheet(ui.sheetMenu);
  
  document.body.onclick = (e) => {
    if(!e.target.closest('.bottom-sheet') && !e.target.closest('.mobile-dock')) closeSheets();
    if(!e.target.closest('.input-group')) { ui.d_sug.style.display='none'; ui.m_sug.style.display='none'; }
  };

  // Init
  const p = new URLSearchParams(location.search);
  if(p.has('lat')) { STATE.lat = parseFloat(p.get('lat')); STATE.lon = parseFloat(p.get('lon')); }
  if(p.has('l')) STATE.layer = p.get('l');
  
  renderPins();
  updateMap();
  updateMarker();
})();
</script>
</body>
</html>