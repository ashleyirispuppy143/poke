<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PokeMaps Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0f172a" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Colors */
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --bg: #ffffff;
      --surface: #f8fafc;
      --panel-bg: rgba(255, 255, 255, 0.85);
      --border: #e2e8f0;
      --text-main: #0f172a;
      --text-sub: #64748b;
      --danger: #ef4444;
      
      /* Dimensions */
      --sidebar-width: 360px;
      --header-height: 60px;
      --radius: 16px;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --glass: blur(12px);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f172a;
        --surface: #1e293b;
        --panel-bg: rgba(15, 23, 42, 0.85);
        --border: #334155;
        --text-main: #f8fafc;
        --text-sub: #94a3b8;
      }
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    /* --- ICON SYSTEM --- */
    svg.icon { width: 20px; height: 20px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    
    /* --- LAYOUT SHELL --- */
    .app-shell {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
    }

    /* --- MAP LAYER --- */
    #map-container {
      position: absolute;
      inset: 0;
      z-index: 0;
      background: #e5e5e5;
    }
    iframe#map { width: 100%; height: 100%; border: 0; display: block; }

    /* Map Markers */
    .marker-overlay { position: absolute; inset: 0; pointer-events: none; z-index: 10; }
    .center-marker {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 24px; height: 24px;
      border-radius: 50%;
      background: var(--danger);
      box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.3);
      transition: all 0.2s ease;
    }
    .center-marker.hidden { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
    .center-marker.crosshair {
      background: transparent; border-radius: 0; box-shadow: none;
    }
    .center-marker.crosshair::before, .center-marker.crosshair::after {
      content: ''; position: absolute; background: var(--danger);
      top: 50%; left: 50%; transform: translate(-50%, -50%);
    }
    .center-marker.crosshair::before { width: 40px; height: 2px; }
    .center-marker.crosshair::after { width: 2px; height: 40px; }

    /* --- UI LAYER --- */
    .ui-layer {
      position: absolute;
      inset: 0;
      z-index: 20;
      pointer-events: none; /* Let clicks pass to map where there is no UI */
    }
    .ui-layer > * { pointer-events: auto; }

    /* Common Components */
    .btn {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      border: 1px solid var(--border);
      background: var(--panel-bg);
      backdrop-filter: var(--glass); -webkit-backdrop-filter: var(--glass);
      color: var(--text-main);
      border-radius: 12px;
      padding: 10px 14px;
      font-size: 14px; font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      box-shadow: var(--shadow-sm);
    }
    .btn:hover { background: var(--surface); border-color: var(--text-sub); }
    .btn:active { transform: scale(0.96); }
    .btn-primary { background: var(--accent); color: #fff; border: 0; }
    .btn-primary:hover { background: var(--accent-hover); border: 0; }
    .btn-icon { width: 44px; height: 44px; padding: 0; border-radius: 50%; }

    .input-group { position: relative; width: 100%; }
    .search-input {
      width: 100%;
      height: 48px;
      padding: 0 16px 0 48px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--panel-bg);
      backdrop-filter: var(--glass); -webkit-backdrop-filter: var(--glass);
      color: var(--text-main);
      font-size: 16px;
      box-shadow: var(--shadow-lg);
      outline: none;
      transition: border-color 0.2s;
    }
    .search-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); }
    .search-icon { position: absolute; left: 14px; top: 14px; color: var(--text-sub); pointer-events: none; }

    /* Suggestions List */
    .suggestions {
      position: absolute; top: calc(100% + 8px); left: 0; right: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      display: none;
      box-shadow: var(--shadow-lg);
      max-height: 300px; overflow-y: auto;
    }
    .suggestions li {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      display: flex; align-items: center; gap: 10px;
      font-size: 14px;
    }
    .suggestions li:last-child { border-bottom: none; }
    .suggestions li:hover, .suggestions li.active { background: rgba(125,125,125,0.1); }
    .suggestions mark { background: transparent; color: var(--accent); font-weight: 600; }

    /* --- DESKTOP SPECIFIC UI --- */
    @media (min-width: 769px) {
      .mobile-only { display: none !important; }
      
      .desktop-sidebar {
        position: absolute; top: 16px; left: 16px; bottom: 16px;
        width: var(--sidebar-width);
        display: flex; flex-direction: column; gap: 16px;
        z-index: 30;
      }

      /* Floating Card Style for Sidebar */
      .sidebar-card {
        background: var(--panel-bg);
        backdrop-filter: var(--glass); -webkit-backdrop-filter: var(--glass);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow-lg);
        overflow: hidden;
        display: flex; flex-direction: column;
      }
      
      .scroll-container { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 20px; }

      .section-title { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); margin-bottom: 8px; font-weight: 700; }
      .row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
      .row.wrap { flex-wrap: wrap; }
      
      /* Right Side Tools */
      .desktop-tools {
        position: absolute; top: 16px; right: 16px;
        display: flex; flex-direction: column; gap: 12px;
      }
      
      /* Bottom Info */
      .desktop-footer {
        position: absolute; bottom: 16px; right: 16px;
        background: var(--panel-bg);
        backdrop-filter: var(--glass);
        padding: 6px 12px;
        border-radius: 8px;
        font-family: monospace;
        font-size: 12px;
        border: 1px solid var(--border);
        pointer-events: none;
      }
    }

    /* --- MOBILE SPECIFIC UI --- */
    @media (max-width: 768px) {
      .desktop-only { display: none !important; }

      /* Top Search Bar (Floating) */
      .mobile-header {
        position: absolute; top: 12px; left: 12px; right: 12px;
        z-index: 30;
      }

      /* Bottom Navigation Dock */
      .mobile-dock {
        position: absolute; bottom: 24px; left: 50%;
        transform: translateX(-50%);
        display: flex; align-items: center; gap: 12px;
        background: var(--panel-bg);
        backdrop-filter: var(--glass); -webkit-backdrop-filter: var(--glass);
        padding: 8px 12px;
        border-radius: 24px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-lg);
        z-index: 30;
      }
      
      /* Bottom Sheet (Settings/Pins/Details) */
      .bottom-sheet {
        position: fixed; left: 0; right: 0; bottom: 0;
        background: var(--surface);
        border-top-left-radius: 24px; border-top-right-radius: 24px;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
        z-index: 100;
        transform: translateY(110%);
        transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        max-height: 85vh;
        display: flex; flex-direction: column;
      }
      .bottom-sheet.open { transform: translateY(0); }
      
      .sheet-handle {
        width: 100%; height: 24px;
        display: flex; align-items: center; justify-content: center;
        flex-shrink: 0; cursor: grab;
      }
      .sheet-handle::after { content: ''; width: 40px; height: 5px; background: var(--border); border-radius: 10px; }
      
      .sheet-content {
        overflow-y: auto;
        padding: 0 20px 20px 20px;
      }

      .mobile-btn-label { font-size: 10px; margin-top: 2px; }
      .dock-item { display: flex; flex-direction: column; align-items: center; gap: 2px; }
    }

    /* --- FORM ELEMENTS --- */
    select.styled-select {
      appearance: none; background: var(--surface);
      border: 1px solid var(--border); color: var(--text-main);
      padding: 10px 12px; border-radius: 8px; width: 100%;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23999%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
      background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto;
    }
    .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); }
    .toggle-row:last-child { border-bottom: 0; }
    
    input[type="range"] { width: 100%; accent-color: var(--accent); }
    input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--accent); }
    
    .pin-card {
      background: rgba(127,127,127,0.05);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 8px;
    }
    .pin-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 600; }
    .pin-coords { font-family: monospace; font-size: 11px; color: var(--text-sub); }
  </style>
</head>
<body>

<div style="display:none">
  <svg id="icons">
    <symbol id="icon-search" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></symbol>
    <symbol id="icon-map-pin" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></symbol>
    <symbol id="icon-navigation" viewBox="0 0 24 24"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></symbol>
    <symbol id="icon-layers" viewBox="0 0 24 24"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></symbol>
    <symbol id="icon-settings" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></symbol>
    <symbol id="icon-star" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></symbol>
    <symbol id="icon-x" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></symbol>
    <symbol id="icon-plus" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></symbol>
    <symbol id="icon-share" viewBox="0 0 24 24"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></symbol>
  </svg>
</div>

<div class="app-shell">
  
  <div id="map-container">
    <iframe id="map" title="Map View"></iframe>
    <div class="marker-overlay">
      <div id="center-marker" class="center-marker"></div>
    </div>
  </div>

  <div class="ui-layer">

    <div class="mobile-only mobile-header">
      <div class="input-group">
        <svg class="icon search-icon"><use href="#icon-search"/></svg>
        <input type="text" id="m-search" class="search-input" placeholder="Search places..." autocomplete="off">
        <ul id="m-suggestions" class="suggestions"></ul>
      </div>
    </div>

    <div class="mobile-only mobile-dock">
      <div class="dock-item">
        <button class="btn btn-icon" id="m-btn-pins"><svg class="icon"><use href="#icon-star"/></svg></button>
      </div>
      <div class="dock-item">
        <button class="btn btn-icon btn-primary" id="m-btn-locate"><svg class="icon"><use href="#icon-navigation"/></svg></button>
      </div>
      <div class="dock-item">
        <button class="btn btn-icon" id="m-btn-menu"><svg class="icon"><use href="#icon-settings"/></svg></button>
      </div>
    </div>

    <div class="mobile-only bottom-sheet" id="sheet-settings">
      <div class="sheet-handle"></div>
      <div class="sheet-content">
        <div class="section-title" style="margin: 10px 0; font-weight:700;">Settings & Layers</div>
        <div class="row">
          <select id="m-layer-select" class="styled-select">
             <option value="mapnik">Standard</option>
             <option value="cyclemap">Cyclist</option>
             <option value="transportmap">Transport</option>
             <option value="hot">Humanitarian</option>
          </select>
        </div>
        <div class="toggle-row">
           <span>Follow Location</span>
           <input type="checkbox" id="m-toggle-follow">
        </div>
        <div class="toggle-row">
           <span>Show Coordinates</span>
           <input type="checkbox" id="m-toggle-coords">
        </div>
        <div class="toggle-row">
           <span>Dark Mode</span>
           <select id="m-theme-select" class="styled-select" style="width:auto">
             <option value="auto">Auto</option><option value="dark">Dark</option><option value="light">Light</option>
           </select>
        </div>
        <div class="row" style="margin-top:20px">
           <button class="btn" style="flex:1" id="m-share">Share Loc</button>
           <button class="btn" style="flex:1" id="m-reset">Reset</button>
        </div>
      </div>
    </div>

    <div class="mobile-only bottom-sheet" id="sheet-pins">
      <div class="sheet-handle"></div>
      <div class="sheet-content">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <div class="section-title" style="margin:15px 0;">Saved Pins</div>
          <button class="btn btn-primary" id="m-save-curr" style="padding: 6px 12px; font-size:12px;">+ Save Here</button>
        </div>
        <div id="m-pin-list"></div>
      </div>
    </div>


    <div class="desktop-only desktop-sidebar">
      <div class="sidebar-card" style="flex: 0 0 auto; margin-bottom: 12px; padding: 12px;">
        <div class="input-group">
          <svg class="icon search-icon"><use href="#icon-search"/></svg>
          <input type="text" id="d-search" class="search-input" placeholder="Search places..." autocomplete="off">
          <ul id="d-suggestions" class="suggestions"></ul>
        </div>
      </div>

      <div class="sidebar-card" style="flex: 1; min-height: 0;">
        <div class="scroll-container">
          
          <div>
            <div class="section-title">Quick Actions</div>
            <div class="row">
              <button class="btn" id="d-btn-locate" style="flex:1"><svg class="icon"><use href="#icon-navigation"/></svg> Locate Me</button>
              <button class="btn" id="d-btn-follow" style="flex:1">Follow</button>
            </div>
            <div class="row">
              <button class="btn" id="d-btn-share" style="flex:1"><svg class="icon"><use href="#icon-share"/></svg> Share</button>
              <button class="btn" id="d-btn-reset" style="flex:1">Reset</button>
            </div>
          </div>

          <hr style="border:0; border-top:1px solid var(--border); width:100%; margin:0;">

          <div>
            <div class="section-title" style="display:flex; justify-content:space-between;">
              <span>Saved Pins</span>
              <button id="d-save-pin" style="background:none; border:none; color:var(--accent); cursor:pointer; font-size:11px; font-weight:700;">+ SAVE CURRENT</button>
            </div>
            <div id="d-pin-list">
              </div>
          </div>

          <hr style="border:0; border-top:1px solid var(--border); width:100%; margin:0;">

          <div>
            <div class="section-title">Map Settings</div>
            <div class="row">
               <label style="flex:1; font-size:14px">Map Layer</label>
               <select id="d-layer-select" class="styled-select" style="width:140px; padding:6px;">
                 <option value="mapnik">Standard</option>
                 <option value="cyclemap">Cyclist</option>
                 <option value="transportmap">Transport</option>
                 <option value="hot">Humanitarian</option>
               </select>
            </div>
            <div class="toggle-row">
               <label>Show Coordinates</label>
               <input type="checkbox" id="d-check-coords">
            </div>
            <div class="toggle-row">
               <label>Theme</label>
               <select id="d-theme-select" class="styled-select" style="width:100px; padding:4px;">
                 <option value="auto">Auto</option><option value="dark">Dark</option><option value="light">Light</option>
               </select>
            </div>
          </div>
          
        </div>
      </div>
    </div>

    <div class="desktop-only desktop-tools">
      <button class="btn btn-icon" onclick="window.open('https://www.openstreetmap.org','_blank')" title="Open OSM Website"><svg class="icon"><use href="#icon-map-pin"/></svg></button>
      <button class="btn btn-icon" onclick="window.open('https://maps.google.com','_blank')" title="Compare Google Maps"><span style="font-weight:700; font-size:18px">G</span></button>
    </div>

    <div class="desktop-only desktop-footer" id="d-coords-display">
      0.0000, 0.0000
    </div>

  </div>
</div>

<script>
;(() => {
  // --- STATE & CONFIG ---
  const STATE = { lat: 30.41, lon: 72.44, delta: 0.25, layer: 'mapnik', following: false };
  const PREFS = JSON.parse(localStorage.getItem('pm_prefs') || '{}');
  const PINS = JSON.parse(localStorage.getItem('pm_pins') || '[]');
  
  const LAYERS = ["mapnik","cyclemap","transportmap","hot"];
  const EL = (sel) => document.querySelector(sel);
  
  // --- DOM ELEMENTS ---
  const ui = {
    map: EL('#map'),
    marker: EL('#center-marker'),
    d_search: EL('#d-search'), d_sug: EL('#d-suggestions'),
    m_search: EL('#m-search'), m_sug: EL('#m-suggestions'),
    d_coords: EL('#d-coords-display'),
    
    // Desktop Inputs
    d_locate: EL('#d-btn-locate'), d_follow: EL('#d-btn-follow'),
    d_share: EL('#d-btn-share'), d_reset: EL('#d-btn-reset'),
    d_layer: EL('#d-layer-select'), d_theme: EL('#d-theme-select'),
    d_coordsCheck: EL('#d-check-coords'), d_save: EL('#d-save-pin'),
    d_pinList: EL('#d-pin-list'),

    // Mobile Inputs
    m_menuBtn: EL('#m-btn-menu'), m_locateBtn: EL('#m-btn-locate'), m_pinsBtn: EL('#m-btn-pins'),
    m_sheetSettings: EL('#sheet-settings'), m_sheetPins: EL('#sheet-pins'),
    m_layer: EL('#m-layer-select'), m_theme: EL('#m-theme-select'),
    m_followCheck: EL('#m-toggle-follow'), m_coordsCheck: EL('#m-toggle-coords'),
    m_save: EL('#m-save-curr'), m_pinList: EL('#m-pin-list'),
    m_share: EL('#m-share'), m_reset: EL('#m-reset')
  };

  // --- CORE MAP LOGIC ---
  const updateMap = (pushState = false) => {
    // Clamping
    STATE.delta = Math.max(0.0005, Math.min(45, STATE.delta));
    
    // Construct Embed URL
    const bbox = {
      left: (STATE.lon - STATE.delta).toFixed(6),
      bottom: (STATE.lat - STATE.delta).toFixed(6),
      right: (STATE.lon + STATE.delta).toFixed(6),
      top: (STATE.lat + STATE.delta).toFixed(6)
    };
    const src = `https://www.openstreetmap.org/export/embed.html?bbox=${bbox.left}%2C${bbox.bottom}%2C${bbox.right}%2C${bbox.top}&layer=${STATE.layer}`;
    
    if (ui.map.src !== src) ui.map.src = src;

    // Update URL
    if (pushState) {
      const url = new URL(window.location);
      url.searchParams.set('lat', STATE.lat.toFixed(5));
      url.searchParams.set('lon', STATE.lon.toFixed(5));
      url.searchParams.set('d', STATE.delta.toFixed(4));
      url.searchParams.set('l', STATE.layer);
      history.pushState(STATE, '', url);
    }
    
    updateUI();
  };

  const updateUI = () => {
    const coordText = `${STATE.lat.toFixed(5)}, ${STATE.lon.toFixed(5)}`;
    ui.d_coords.textContent = coordText;
    
    // Sync Inputs
    if(ui.d_layer.value !== STATE.layer) ui.d_layer.value = STATE.layer;
    if(ui.m_layer.value !== STATE.layer) ui.m_layer.value = STATE.layer;
    
    // Marker Pulse if following
    ui.marker.style.boxShadow = STATE.following ? '0 0 0 8px rgba(59, 130, 246, 0.4)' : '';
    ui.marker.style.background = STATE.following ? 'var(--accent)' : 'var(--danger)';
  };

  // --- LOCATION SERVICES ---
  let watchId = null;
  const toggleFollow = () => {
    if (STATE.following) {
      STATE.following = false;
      if (watchId) navigator.geolocation.clearWatch(watchId);
      ui.d_follow.textContent = "Follow";
      ui.m_followCheck.checked = false;
      updateUI();
    } else {
      if (!navigator.geolocation) return alert("Geo not supported");
      STATE.following = true;
      ui.d_follow.textContent = "Stop Following";
      ui.m_followCheck.checked = true;
      
      watchId = navigator.geolocation.watchPosition(
        (pos) => {
           STATE.lat = pos.coords.latitude;
           STATE.lon = pos.coords.longitude;
           updateMap();
        }, 
        (err) => { alert("Loc Error"); toggleFollow(); },
        { enableHighAccuracy: true }
      );
      updateUI();
    }
  };

  const locateOnce = () => {
    navigator.geolocation.getCurrentPosition(pos => {
      STATE.lat = pos.coords.latitude;
      STATE.lon = pos.coords.longitude;
      STATE.delta = 0.01; // Zoom in
      updateMap(true);
    }, err => alert(err.message));
  };

  // --- SEARCH ---
  let debounceTimer;
  const handleSearch = async (val, suggestionEl) => {
    if (!val || val.length < 3) { suggestionEl.style.display = 'none'; return; }
    
    // Check if lat,lon
    const coordMatch = val.match(/([+-]?\d+\.?\d*)\s*,\s*([+-]?\d+\.?\d*)/);
    if(coordMatch) {
      const lat = parseFloat(coordMatch[1]), lon = parseFloat(coordMatch[2]);
      suggestionEl.innerHTML = `<li data-lat="${lat}" data-lon="${lon}">üìç Go to ${lat}, ${lon}</li>`;
      suggestionEl.style.display = 'block';
      return;
    }

    // Nominatim
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(async () => {
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}`);
        const data = await res.json();
        suggestionEl.innerHTML = '';
        if (data.length === 0) { suggestionEl.style.display='none'; return; }
        
        data.slice(0, 5).forEach(item => {
          const li = document.createElement('li');
          li.innerHTML = `<span>${item.display_name}</span>`;
          li.onclick = () => {
             STATE.lat = parseFloat(item.lat);
             STATE.lon = parseFloat(item.lon);
             updateMap(true);
             suggestionEl.style.display = 'none';
             ui.d_search.value = item.display_name.split(',')[0];
             ui.m_search.value = item.display_name.split(',')[0];
          };
          suggestionEl.appendChild(li);
        });
        suggestionEl.style.display = 'block';
      } catch(e) {}
    }, 300);
  };

  // --- PINS SYSTEM ---
  const renderPins = () => {
    const html = PINS.map((pin, idx) => `
      <div class="pin-card">
        <div class="pin-header">
           <span>${pin.name}</span>
           <div style="display:flex; gap:8px">
             <button onclick="gotoPin(${idx})" style="border:0;background:none;cursor:pointer;color:var(--accent)">Go</button>
             <button onclick="deletePin(${idx})" style="border:0;background:none;cursor:pointer;color:var(--text-sub)">‚úï</button>
           </div>
        </div>
        <div class="pin-coords">${pin.lat.toFixed(4)}, ${pin.lon.toFixed(4)}</div>
      </div>
    `).join('');
    
    if(PINS.length === 0) {
      const empty = '<div style="padding:10px; opacity:0.6; font-size:13px; text-align:center">No pins saved yet</div>';
      ui.d_pinList.innerHTML = empty;
      ui.m_pinList.innerHTML = empty;
    } else {
      ui.d_pinList.innerHTML = html;
      ui.m_pinList.innerHTML = html;
    }
  };
  
  window.gotoPin = (i) => {
    STATE.lat = PINS[i].lat; STATE.lon = PINS[i].lon; STATE.layer = PINS[i].layer;
    updateMap(true);
    // If mobile, close sheet
    ui.m_sheetPins.classList.remove('open');
  };
  window.deletePin = (i) => {
    if(!confirm('Remove pin?')) return;
    PINS.splice(i, 1);
    localStorage.setItem('pm_pins', JSON.stringify(PINS));
    renderPins();
  };
  
  const saveCurrentPin = () => {
    const name = prompt("Name this location:", "New Pin");
    if(!name) return;
    PINS.unshift({ name, lat: STATE.lat, lon: STATE.lon, layer: STATE.layer });
    localStorage.setItem('pm_pins', JSON.stringify(PINS));
    renderPins();
  };

  // --- MOBILE SHEET HANDLERS ---
  const toggleSheet = (sheet) => {
    const isOpen = sheet.classList.contains('open');
    // Close all first
    document.querySelectorAll('.bottom-sheet').forEach(s => s.classList.remove('open'));
    if (!isOpen) sheet.classList.add('open');
  };
  
  // Close sheets when clicking map (UI layer passes through, but we detect clicks on the layer wrapper if needed, 
  // actually better to just listen to map interaction blocker)
  document.body.addEventListener('click', (e) => {
     if (e.target.closest('.bottom-sheet') || e.target.closest('.mobile-dock')) return;
     document.querySelectorAll('.bottom-sheet').forEach(s => s.classList.remove('open'));
  });

  // --- EVENT LISTENERS ---
  
  // Search
  ui.d_search.addEventListener('input', (e) => handleSearch(e.target.value, ui.d_sug));
  ui.m_search.addEventListener('input', (e) => handleSearch(e.target.value, ui.m_sug));
  
  // Desktop Actions
  ui.d_locate.onclick = locateOnce;
  ui.d_follow.onclick = toggleFollow;
  ui.d_reset.onclick = () => { STATE.lat=30; STATE.lon=10; STATE.delta=10; updateMap(true); };
  ui.d_share.onclick = () => { navigator.clipboard.writeText(window.location.href); alert("Link copied!"); };
  ui.d_layer.onchange = (e) => { STATE.layer = e.target.value; updateMap(true); };
  ui.d_save.onclick = saveCurrentPin;
  ui.d_theme.onchange = (e) => applyTheme(e.target.value);
  ui.d_coordsCheck.onchange = (e) => { ui.d_coords.style.display = e.target.checked ? 'block' : 'none'; };
  
  // Mobile Actions
  ui.m_menuBtn.onclick = () => toggleSheet(ui.m_sheetSettings);
  ui.m_pinsBtn.onclick = () => toggleSheet(ui.m_sheetPins);
  ui.m_locateBtn.onclick = locateOnce;
  ui.m_layer.onchange = (e) => { STATE.layer = e.target.value; updateMap(true); };
  ui.m_save.onclick = saveCurrentPin;
  ui.m_followCheck.onchange = toggleFollow;
  ui.m_theme.onchange = (e) => applyTheme(e.target.value);
  ui.m_share.onclick = ui.d_share.onclick;
  ui.m_reset.onclick = ui.d_reset.onclick;

  // --- INITIALIZATION ---
  const applyTheme = (t) => {
    document.documentElement.style.colorScheme = t === 'auto' ? 'dark light' : t;
    // Persist
    PREFS.theme = t; localStorage.setItem('pm_prefs', JSON.stringify(PREFS));
    ui.d_theme.value = t; ui.m_theme.value = t;
  };
  
  const init = () => {
    // URL Params
    const q = new URLSearchParams(location.search);
    if(q.has('lat')) STATE.lat = parseFloat(q.get('lat'));
    if(q.has('lon')) STATE.lon = parseFloat(q.get('lon'));
    if(q.has('d')) STATE.delta = parseFloat(q.get('d'));
    if(q.has('l')) STATE.layer = q.get('l');
    
    // Load Prefs
    if(PREFS.theme) applyTheme(PREFS.theme);
    
    renderPins();
    updateMap();
  };

  init();

})();
</script>
</body>
</html>