<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PokeMaps Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0f172a" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Colors */
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --bg: #0f172a;
      --panel-bg: rgba(15, 23, 42, 0.8);
      --border: rgba(255, 255, 255, 0.1);
      --text-main: #ffffff;
      --text-sub: #94a3b8;
      --danger: #ef4444;
      
      /* Dimensions */
      --nav-height: 64px;
      --radius: 16px;
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      --glass: blur(12px) saturate(180%);
      
      /* Settings Defaults */
      --marker-size: 20px;
      --marker-color: #ef4444;
    }

    /* Light Mode Override */
    @media (prefers-color-scheme: light) {
      body.light-mode {
        --panel-bg: rgba(255, 255, 255, 0.9);
        --border: #e2e8f0;
        --text-main: #0f172a;
        --text-sub: #64748b;
        --shadow: 0 4px 20px rgba(0,0,0,0.1);
      }
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    body { font-family: 'Inter', system-ui, sans-serif; background: #111; color: var(--text-main); }
    button { font-family: inherit; }

    /* --- ICONS --- */
    svg.icon { width: 18px; height: 18px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

    /* --- MAP --- */
    .app-shell { position: relative; width: 100%; height: 100%; }
    #map-container { position: absolute; inset: 0; z-index: 0; background: #222; }
    iframe#map { width: 100%; height: 100%; border: 0; display: block; }

    /* Brand Tag (Bottom Center) - Hidden on Mobile via Media Query below */
    .brand {
      position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
      padding: 6px 12px; font-size: 12px; font-weight: 600; opacity: 0.8;
      background: var(--panel-bg); backdrop-filter: var(--glass);
      border-radius: 20px; border: 1px solid var(--border);
      pointer-events: none; z-index: 5; color: var(--text-main);
    }

    /* Marker */
    .marker-overlay { position: absolute; inset: 0; pointer-events: none; z-index: 10; display: flex; align-items: center; justify-content: center; }
    .center-marker {
      width: var(--marker-size); height: var(--marker-size); border-radius: 50%;
      background: var(--marker-color);
      box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.3);
      transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .center-marker::after {
      content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 4px; height: 4px; background: rgba(0,0,0,0.5); border-radius: 50%;
    }

    /* --- UI LAYER --- */
    .ui-layer { position: absolute; inset: 0; z-index: 20; pointer-events: none; }
    .ui-layer > * { pointer-events: auto; }

    /* --- COMMON COMPONENTS --- */
    .btn {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      border: 1px solid transparent; background: transparent; color: var(--text-sub);
      border-radius: 8px; padding: 8px 12px; font-size: 14px; font-weight: 500;
      cursor: pointer; transition: all 0.2s;
    }
    .btn:hover { background: rgba(255,255,255,0.05); color: var(--text-main); }
    .btn.active { background: rgba(59, 130, 246, 0.15); color: var(--accent); }
    
    .btn-filled {
      background: var(--accent); color: white; border-radius: 8px;
      padding: 8px 16px; font-weight: 600; box-shadow: 0 2px 10px rgba(59, 130, 246, 0.4);
    }
    .btn-filled:hover { background: var(--accent-hover); transform: translateY(-1px); }

    .input-group { position: relative; display: flex; align-items: center; }
    .search-input {
      width: 100%; height: 40px; padding: 0 16px 0 40px;
      border-radius: 10px; border: 1px solid var(--border);
      background: rgba(0,0,0,0.2); color: var(--text-main);
      font-size: 14px; outline: none; transition: all 0.2s;
    }
    .search-input:focus { background: rgba(0,0,0,0.4); border-color: var(--accent); }
    .search-icon { position: absolute; left: 12px; color: var(--text-sub); pointer-events: none; }

    /* Rich Dropdown */
    .suggestions {
      position: absolute; top: calc(100% + 8px); left: 0; width: 100%; min-width: 300px;
      background: var(--panel-bg); backdrop-filter: var(--glass);
      border: 1px solid var(--border); border-radius: 12px;
      margin: 0; padding: 6px; list-style: none;
      box-shadow: var(--shadow); max-height: 400px; overflow-y: auto; display: none;
      animation: slideDown 0.2s ease-out; z-index: 1000;
    }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    
    .suggestions li {
      padding: 10px; border-radius: 8px; cursor: pointer;
      display: flex; align-items: center; gap: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.03);
    }
    .suggestions li:hover { background: rgba(255,255,255,0.1); }
    .suggestions li:last-child { border-bottom: 0; }
    
    .sug-icon {
      width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
      background: rgba(59, 130, 246, 0.15); color: var(--accent);
      border-radius: 8px; flex-shrink: 0;
    }
    .sug-text { display: flex; flex-direction: column; overflow: hidden; }
    .sug-title { font-weight: 600; font-size: 14px; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sug-sub { font-size: 12px; color: var(--text-sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }


    /* --- DESKTOP NAVBAR LAYOUT --- */
    @media (min-width: 769px) {
      .mobile-only { display: none !important; }

      .desktop-navbar {
        position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
        width: auto; min-width: 600px; max-width: 90%; height: var(--nav-height);
        background: var(--panel-bg); backdrop-filter: var(--glass);
        border: 1px solid var(--border); border-radius: 20px;
        box-shadow: var(--shadow);
        display: flex; align-items: center; padding: 0 16px; gap: 16px;
        z-index: 50;
      }

      .nav-brand { font-weight: 700; font-size: 15px; display: flex; align-items: center; gap: 8px; padding-right: 16px; border-right: 1px solid var(--border); }
      .nav-search { flex: 1; min-width: 300px; }
      .nav-actions { display: flex; align-items: center; gap: 4px; padding-left: 8px; }

      /* Popover Panels (Pins, Settings) */
      .popover {
        position: absolute; top: calc(100% + 12px); right: 0;
        width: 320px; background: var(--panel-bg); backdrop-filter: var(--glass);
        border: 1px solid var(--border); border-radius: 16px;
        box-shadow: var(--shadow); padding: 16px;
        display: none; flex-direction: column; gap: 12px;
        animation: popIn 0.2s cubic-bezier(0.16, 1, 0.3, 1);
      }
      .popover.open { display: flex; }
      @keyframes popIn { from { opacity: 0; transform: translateY(-8px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

      .popover-header { font-weight: 600; font-size: 14px; border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-bottom: 4px; display: flex; justify-content: space-between; }
      
      .row { display: flex; justify-content: space-between; align-items: center; }
      
      /* Tools */
      .desktop-tools { position: absolute; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 10px; }
      .tool-btn {
        width: 44px; height: 44px; border-radius: 12px; border: 1px solid var(--border);
        background: var(--panel-bg); backdrop-filter: var(--glass); color: var(--text-main);
        display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: var(--shadow);
      }
      .tool-btn:hover { background: rgba(255,255,255,0.1); }
    }

    /* --- MOBILE LAYOUT --- */
    @media (max-width: 768px) {
      .desktop-only { display: none !important; }
      
      /* Hide Brand on Mobile */
      .brand { display: none !important; }

      /* Search FAB (Top Right) */
      .mobile-search-fab {
        position: absolute; top: 16px; right: 16px; z-index: 30;
        width: 48px; height: 48px; border-radius: 50%;
        background: var(--panel-bg); backdrop-filter: var(--glass);
        border: 1px solid var(--border); box-shadow: var(--shadow);
        display: flex; align-items: center; justify-content: center;
        color: var(--text-main); cursor: pointer;
      }
      .mobile-search-fab:active { transform: scale(0.95); }

      /* Mobile Dock (Bottom) */
      .mobile-dock {
        position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
        display: flex; gap: 24px; align-items: center;
        background: var(--panel-bg); backdrop-filter: var(--glass);
        padding: 12px 28px; border-radius: 32px; border: 1px solid var(--border);
        box-shadow: var(--shadow); z-index: 30;
      }
      .dock-btn { background: none; border: none; color: var(--text-sub); padding: 4px; cursor: pointer; }
      .dock-btn.main { 
        background: var(--accent); color: white; width: 56px; height: 56px; border-radius: 20px; 
        display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); margin: -20px 0 0 0;
      }
      
      /* Bottom Sheets */
      .bottom-sheet {
        position: fixed; left: 0; right: 0; bottom: 0;
        background: #1e293b;
        border-top: 1px solid var(--border); border-radius: 24px 24px 0 0;
        box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        z-index: 40; transform: translateY(110%);
        transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
        max-height: 85vh; display: flex; flex-direction: column;
      }
      .bottom-sheet.open { transform: translateY(0); }
      .sheet-handle { width: 40px; height: 4px; background: var(--border); border-radius: 10px; margin: 12px auto; opacity: 0.5; }
      .sheet-content { padding: 10px 20px 40px; overflow-y: auto; }

      /* Mobile Suggestions Fix */
      #m-suggestions {
        position: relative; top: 0; left: 0; width: 100%;
        background: transparent; border: none; box-shadow: none;
        max-height: none; padding: 0; margin-top: 10px;
        animation: none;
      }
    }

    /* Utility */
    .pin-item {
      padding: 12px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 10px;
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;
    }
    .pin-info strong { display: block; font-size: 13px; margin-bottom: 2px; }
    .pin-info span { font-size: 11px; color: var(--text-sub); font-family: monospace; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; }
    .pin-btn { background: none; border: 1px solid var(--border); border-radius: 6px; padding: 4px 8px; color: var(--text-sub); cursor: pointer; font-size: 11px; }
    .pin-btn:hover { border-color: var(--accent); color: var(--accent); }

    select.std-select {
      width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border);
      background: rgba(0,0,0,0.2); color: var(--text-main); outline: none; cursor: pointer;
    }
    input[type="range"] { accent-color: var(--accent); width: 100px; }
    input[type="color"] { background: none; border: 0; width: 30px; height: 30px; cursor: pointer; }
    label { font-size: 13px; color: var(--text-sub); font-weight: 500; }
    .link-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .link-pill { font-size: 10px; color: var(--text-sub); text-decoration: none; border: 1px solid var(--border); padding: 4px 8px; border-radius: 20px; }
    .link-pill:hover { border-color: var(--accent); color: var(--accent); }

  </style>
</head>
<body>

<div style="display:none">
  <svg id="icons">
    <symbol id="icon-search" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></symbol>
    <symbol id="icon-nav" viewBox="0 0 24 24"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></symbol>
    <symbol id="icon-menu" viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></symbol>
    <symbol id="icon-pin" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></symbol>
    <symbol id="icon-settings" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></symbol>
    <symbol id="icon-share" viewBox="0 0 24 24"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></symbol>
    <symbol id="icon-loc" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7z"></path><circle cx="12" cy="9" r="2.5"></circle></symbol>
  </svg>
</div>

<div class="app-shell">
  
  <div id="map-container">
    <iframe id="map" title="Map"></iframe>
    <div class="marker-overlay">
      <div id="center-marker" class="center-marker"></div>
    </div>
    <div class="brand">PokeMaps Pro</div>
  </div>

  <div class="ui-layer">

    <div class="desktop-only desktop-navbar">
      <div class="nav-brand">
        <svg class="icon" style="color:var(--accent)"><use href="#icon-loc"/></svg>
        <span>PokeMaps</span>
      </div>
      
      <div class="nav-search">
        <div class="input-group">
          <svg class="icon search-icon"><use href="#icon-search"/></svg>
          <input type="text" id="d-search" class="search-input" placeholder="Search places..." autocomplete="off">
          <ul id="d-suggestions" class="suggestions"></ul>
        </div>
      </div>
      
      <div class="nav-actions">
        <button class="btn" id="d-btn-pins" title="Saved Pins">
          <svg class="icon"><use href="#icon-pin"/></svg> <span>Pins</span>
        </button>
        <button class="btn" id="d-btn-settings" title="Settings">
          <svg class="icon"><use href="#icon-settings"/></svg>
        </button>
        <div style="width:1px; height:24px; background:var(--border); margin:0 8px;"></div>
        <button class="btn-filled" id="d-locate">Locate</button>
      </div>

      <div class="popover" id="pop-pins">
        <div class="popover-header">
          <span>Saved Locations</span>
          <button class="btn-filled" style="font-size:11px; padding:4px 8px; height:auto;" id="d-save-pin">+ Save</button>
        </div>
        <div id="d-pin-list" style="max-height:300px; overflow-y:auto;"></div>
      </div>

      <div class="popover" id="pop-settings">
        <div class="popover-header">Map Settings</div>
        <div style="display:flex; flex-direction:column; gap:12px;">
          <div>
            <label>Map Layer</label>
            <select id="d-layer" class="std-select" style="margin-top:4px;">
              <option value="mapnik">Standard</option>
              <option value="cyclemap">Cyclist</option>
              <option value="transportmap">Transport</option>
              <option value="hot">Humanitarian</option>
            </select>
          </div>
          <div class="row">
            <label>Follow Location</label>
            <input type="checkbox" id="d-follow" style="width:16px; height:16px; accent-color:var(--accent);">
          </div>
          <div class="row">
            <label>Theme</label>
            <select id="d-theme" class="std-select" style="width:100px; padding:4px;">
              <option value="auto">Auto</option><option value="dark">Dark</option><option value="light">Light</option>
            </select>
          </div>
          <hr style="border:0; border-top:1px solid var(--border); margin:0;">
          <div class="row"><label>Marker Size</label><input type="range" id="d-m-size" min="10" max="50" value="20"></div>
          <div class="row"><label>Marker Color</label><input type="color" id="d-m-color" value="#ef4444"></div>
          <div class="link-row" style="margin-top:8px; padding-top:8px; border-top:1px solid var(--border);">
            <a href="/privacy" class="link-pill">Privacy</a>
            <a href="https://wiki.osmfoundation.org/wiki/Terms_of_Use" target="_blank" class="link-pill">Terms</a>
            <a href="https://www.openstreetmap.org/copyright" target="_blank" class="link-pill">Data © OSM</a>
          </div>
        </div>
      </div>
    </div>

    <div class="desktop-only desktop-tools">
      <button class="tool-btn" id="d-share" title="Share Link"><svg class="icon"><use href="#icon-share"/></svg></button>
    </div>


    <button class="mobile-only mobile-search-fab" id="m-btn-search">
      <svg class="icon"><use href="#icon-search"/></svg>
    </button>

    <div class="mobile-only mobile-dock">
      <button class="dock-btn" id="m-btn-pins"><svg class="icon" style="width:28px; height:28px"><use href="#icon-pin"/></svg></button>
      <button class="dock-btn main" id="m-btn-locate"><svg class="icon" style="width:24px; height:24px"><use href="#icon-nav"/></svg></button>
      <button class="dock-btn" id="m-btn-menu"><svg class="icon" style="width:28px; height:28px"><use href="#icon-menu"/></svg></button>
    </div>

    <div class="mobile-only bottom-sheet" id="sheet-search">
      <div class="sheet-handle"></div>
      <div class="sheet-content">
        <div class="input-group">
          <svg class="icon search-icon"><use href="#icon-search"/></svg>
          <input type="text" id="m-search" class="search-input" placeholder="Search places..." autocomplete="off">
        </div>
        <ul id="m-suggestions" class="suggestions"></ul>
      </div>
    </div>

    <div class="mobile-only bottom-sheet" id="sheet-pins">
      <div class="sheet-handle"></div>
      <div class="sheet-content">
        <div class="row" style="justify-content:space-between; margin-bottom:16px;">
          <strong style="font-size:18px">Saved Pins</strong>
          <button class="btn-filled" id="m-save-curr" style="font-size:12px; padding:6px 12px">+ Save</button>
        </div>
        <div id="m-pin-list" style="display:flex; flex-direction:column; gap:10px; padding-bottom:60px"></div>
      </div>
    </div>

    <div class="mobile-only bottom-sheet" id="sheet-menu">
      <div class="sheet-handle"></div>
      <div class="sheet-content">
        <strong style="font-size:18px; display:block; margin-bottom:20px">Map Settings</strong>
        <div style="margin-bottom:20px">
          <label style="display:block; margin-bottom:8px">Map Layer</label>
          <select id="m-layer" class="std-select">
            <option value="mapnik">Standard</option>
            <option value="cyclemap">Cyclist</option>
            <option value="transportmap">Transport</option>
            <option value="hot">Humanitarian</option>
          </select>
        </div>
        <div class="row" style="justify-content:space-between; padding:14px 0; border-top:1px solid var(--border)">
          <span>Follow Location</span>
          <input type="checkbox" id="m-follow" style="width:20px; height:20px; accent-color:var(--accent)">
        </div>
        <div class="row" style="justify-content:space-between; padding:14px 0; border-top:1px solid var(--border)">
          <span>Theme</span>
          <select id="m-theme" class="std-select" style="width:auto">
            <option value="auto">Auto</option><option value="dark">Dark</option><option value="light">Light</option>
          </select>
        </div>
        <div style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border)">
          <div class="link-row">
            <a class="link-pill" href="https://wiki.osmfoundation.org/wiki/Terms_of_Use">OSM Terms</a>
            <a class="link-pill" href="/privacy">Privacy Policy</a>
          </div>
        </div>
        <div style="height:60px"></div>
      </div>
    </div>

  </div>
</div>

<script>
;(() => {
  // State
  const STATE = { lat: 30.41, lon: 72.44, delta: 0.25, layer: 'mapnik', following: false };
  let PINS = [];
  try { PINS = JSON.parse(localStorage.getItem('pm_pins') || '[]'); } catch(e){}
  
  const EL = (sel) => document.querySelector(sel);
  
  // UI References
  const ui = {
    map: EL('#map'),
    marker: EL('#center-marker'),
    // Desktop Nav
    d_search: EL('#d-search'), d_sug: EL('#d-suggestions'),
    d_locate: EL('#d-locate'), d_save: EL('#d-save-pin'), d_pinList: EL('#d-pin-list'),
    d_layer: EL('#d-layer'), d_follow: EL('#d-follow'), d_theme: EL('#d-theme'), d_share: EL('#d-share'),
    d_mSize: EL('#d-m-size'), d_mColor: EL('#d-m-color'),
    d_btnPins: EL('#d-btn-pins'), d_btnSet: EL('#d-btn-settings'),
    popPins: EL('#pop-pins'), popSet: EL('#pop-settings'),
    // Mobile
    m_btnSearch: EL('#m-btn-search'),
    m_search: EL('#m-search'), m_sug: EL('#m-suggestions'),
    m_locate: EL('#m-btn-locate'), m_pinsBtn: EL('#m-btn-pins'), m_menuBtn: EL('#m-btn-menu'),
    m_save: EL('#m-save-curr'), m_pinList: EL('#m-pin-list'),
    m_layer: EL('#m-layer'), m_follow: EL('#m-follow'), m_theme: EL('#m-theme'),
    sheetSearch: EL('#sheet-search'), sheetPins: EL('#sheet-pins'), sheetMenu: EL('#sheet-menu')
  };

  // --- MAP CORE ---
  const updateMap = (push = false) => {
    STATE.delta = Math.max(0.0005, Math.min(45, STATE.delta));
    const bbox = {
      l: (STATE.lon - STATE.delta).toFixed(6),
      b: (STATE.lat - STATE.delta).toFixed(6),
      r: (STATE.lon + STATE.delta).toFixed(6),
      t: (STATE.lat + STATE.delta).toFixed(6)
    };
    const src = `https://www.openstreetmap.org/export/embed.html?bbox=${bbox.l}%2C${bbox.b}%2C${bbox.r}%2C${bbox.t}&layer=${STATE.layer}`;
    if (ui.map.src !== src) ui.map.src = src;

    if (push) {
      const u = new URL(location);
      u.searchParams.set('lat', STATE.lat.toFixed(5));
      u.searchParams.set('lon', STATE.lon.toFixed(5));
      u.searchParams.set('d', STATE.delta.toFixed(4));
      u.searchParams.set('l', STATE.layer);
      history.pushState(STATE, '', u);
    }
    
    // Sync Inputs
    if(ui.d_layer.value !== STATE.layer) ui.d_layer.value = STATE.layer;
    if(ui.m_layer.value !== STATE.layer) ui.m_layer.value = STATE.layer;
    ui.d_follow.checked = STATE.following; ui.m_follow.checked = STATE.following;
  };

  // --- SEARCH ---
  let timer;
  const doSearch = (val, list) => {
    if (!val || val.length < 3) { list.style.display = 'none'; return; }
    
    // Check Coords
    const m = val.match(/([+-]?\d+\.?\d*)\s*,\s*([+-]?\d+\.?\d*)/);
    if(m) {
      const lat = parseFloat(m[1]), lon = parseFloat(m[2]);
      list.innerHTML = `
        <li onclick="goTo(${lat},${lon})">
          <div class="sug-icon"><svg class="icon"><use href="#icon-loc"/></svg></div>
          <div class="sug-text">
            <span class="sug-title">${lat.toFixed(4)}, ${lon.toFixed(4)}</span>
            <span class="sug-sub">Coordinates</span>
          </div>
        </li>`;
      list.style.display = 'block';
      return;
    }

    clearTimeout(timer);
    timer = setTimeout(async () => {
      try {
        const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}`);
        const d = await r.json();
        list.innerHTML = '';
        if(!d.length) { list.style.display = 'none'; return; }
        
        d.slice(0,5).forEach(i => {
          let parts = i.display_name.split(',');
          let main = parts[0];
          let sub = parts.slice(1).join(',').trim();

          const li = document.createElement('li');
          li.innerHTML = `
            <div class="sug-icon"><svg class="icon"><use href="#icon-loc"/></svg></div>
            <div class="sug-text">
              <span class="sug-title">${main}</span>
              <span class="sug-sub">${sub}</span>
            </div>
          `;
          li.onclick = () => { 
            goTo(parseFloat(i.lat), parseFloat(i.lon)); 
            list.style.display = 'none'; 
            ui.d_search.value = main; ui.m_search.value = main;
            closeSheets();
          };
          list.appendChild(li);
        });
        list.style.display = 'block';
      } catch(e){}
    }, 400);
  };
  
  window.goTo = (lat, lon) => { 
    STATE.lat = lat; STATE.lon = lon; STATE.following = false; updateMap(true); 
  };

  // --- LOCATION & PINS ---
  let watchId = null;
  const toggleFollow = () => {
    if (STATE.following) {
      STATE.following = false;
      if (watchId) navigator.geolocation.clearWatch(watchId);
      updateMap();
    } else {
      if (!navigator.geolocation) return alert("Geolocation not supported");
      STATE.following = true;
      watchId = navigator.geolocation.watchPosition(
        p => { STATE.lat = p.coords.latitude; STATE.lon = p.coords.longitude; updateMap(); },
        e => { STATE.following = false; updateMap(); alert("Location access denied"); },
        { enableHighAccuracy: true }
      );
      updateMap();
    }
  };
  const locateOnce = () => {
    navigator.geolocation.getCurrentPosition(p => {
      STATE.lat = p.coords.latitude; STATE.lon = p.coords.longitude; STATE.delta = 0.01;
      updateMap(true);
    }, e => alert("Could not locate"));
  };

  const renderPins = () => {
    const html = PINS.length ? PINS.map((p, i) => `
      <div class="pin-item">
        <div class="pin-info"><strong>${p.name}</strong><span>${p.lat.toFixed(4)}, ${p.lon.toFixed(4)}</span></div>
        <div>
          <button class="pin-btn" onclick="loadPin(${i})">Go</button>
          <button class="pin-btn" onclick="delPin(${i})" style="color:var(--danger); border-color:var(--danger)">✕</button>
        </div>
      </div>
    `).join('') : '<div style="text-align:center; opacity:0.5; padding:20px; font-size:13px">No saved pins</div>';
    
    ui.d_pinList.innerHTML = html;
    ui.m_pinList.innerHTML = html;
  };

  window.loadPin = (i) => { STATE.lat = PINS[i].lat; STATE.lon = PINS[i].lon; STATE.layer = PINS[i].layer || 'mapnik'; updateMap(true); closeSheets(); };
  window.delPin = (i) => { if(confirm("Remove pin?")){ PINS.splice(i,1); localStorage.setItem('pm_pins', JSON.stringify(PINS)); renderPins(); } };
  
  const savePin = () => {
    const name = prompt("Name this location:", "New Place");
    if(name) {
      PINS.unshift({ name, lat: STATE.lat, lon: STATE.lon, layer: STATE.layer });
      localStorage.setItem('pm_pins', JSON.stringify(PINS));
      renderPins();
    }
  };

  // --- SETTINGS ---
  const updateMarker = () => {
    document.documentElement.style.setProperty('--marker-size', ui.d_mSize.value + 'px');
    document.documentElement.style.setProperty('--marker-color', ui.d_mColor.value);
  };
  ui.d_mSize.oninput = updateMarker; ui.d_mColor.oninput = updateMarker;

  const applyTheme = (t) => {
    document.body.classList.toggle('light-mode', t === 'light');
    if(t === 'auto') document.body.classList.remove('light-mode');
    ui.d_theme.value = t; ui.m_theme.value = t;
  };

  // --- UI TOGGLES ---
  const closeSheets = () => {
    document.querySelectorAll('.bottom-sheet').forEach(s => s.classList.remove('open'));
    document.querySelectorAll('.popover').forEach(p => p.classList.remove('open'));
    ui.d_btnPins.classList.remove('active'); ui.d_btnSet.classList.remove('active');
  };
  const toggleSheet = (s) => { const o = s.classList.contains('open'); closeSheets(); if(!o) s.classList.add('open'); };
  const togglePop = (p, btn) => { 
    const o = p.classList.contains('open'); 
    closeSheets(); 
    if(!o) { p.classList.add('open'); btn.classList.add('active'); }
  };

  // --- LISTENERS ---
  ui.d_search.oninput = (e) => doSearch(e.target.value, ui.d_sug);
  ui.m_search.oninput = (e) => doSearch(e.target.value, ui.m_sug);
  
  ui.d_locate.onclick = locateOnce; ui.m_locate.onclick = locateOnce;
  ui.d_save.onclick = savePin; ui.m_save.onclick = savePin;
  ui.d_share.onclick = () => { navigator.clipboard.writeText(location.href); alert("Link copied!"); };
  
  ui.d_layer.onchange = (e) => { STATE.layer = e.target.value; updateMap(true); };
  ui.m_layer.onchange = (e) => { STATE.layer = e.target.value; updateMap(true); };
  
  ui.d_follow.onchange = toggleFollow; ui.m_follow.onchange = toggleFollow;
  ui.d_theme.onchange = (e) => applyTheme(e.target.value); ui.m_theme.onchange = (e) => applyTheme(e.target.value);
  
  // Desktop Nav Toggles
  ui.d_btnPins.onclick = () => togglePop(ui.popPins, ui.d_btnPins);
  ui.d_btnSet.onclick = () => togglePop(ui.popSet, ui.d_btnSet);

  // Mobile Toggles
  ui.m_btnSearch.onclick = () => { toggleSheet(ui.sheetSearch); setTimeout(() => ui.m_search.focus(), 100); };
  ui.m_pinsBtn.onclick = () => toggleSheet(ui.sheetPins);
  ui.m_menuBtn.onclick = () => toggleSheet(ui.sheetMenu);
  
  document.body.onclick = (e) => {
    if(!e.target.closest('.bottom-sheet') && !e.target.closest('.mobile-dock') && !e.target.closest('.mobile-search-fab') && !e.target.closest('.desktop-navbar')) closeSheets();
    if(!e.target.closest('.input-group')) { ui.d_sug.style.display='none'; }
  };

  // Init
  const p = new URLSearchParams(location.search);
  if(p.has('lat')) { STATE.lat = parseFloat(p.get('lat')); STATE.lon = parseFloat(p.get('lon')); }
  if(p.has('l')) STATE.layer = p.get('l');
  
  renderPins();
  updateMap();
  updateMarker();
})();
</script>
</body>
</html>